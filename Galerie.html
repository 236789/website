<!DOCTYPE html>
<html lang="ro">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B6DWPJ4T2C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B6DWPJ4T2C');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Galerie Portrete ‚Äî KSDAPromovari</title>
  <link rel="icon" type="image/png" href="https://iili.io/fXks1Dv.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* --- VARIABLES & THEME --- */
    :root {
      --bg-dark: #050b14;
      --primary: #29f3ff;
      --primary-dim: rgba(41, 243, 255, 0.15);
      --glass-bg: rgba(13, 25, 41, 0.95);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #a5b1c2;
      --star-color: #ffcc00;
      --transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    * { box-sizing: border-box; outline: none; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0; min-height: 100vh;
      background-color: var(--bg-dark);
      background-image: linear-gradient(to bottom, rgba(5, 11, 20, 0.85), var(--bg-dark)), url('https://i.makeagif.com/media/3-03-2021/otrneG.gif');
      background-position: center; background-size: cover; background-attachment: fixed;
      font-family: 'Poppins', sans-serif; color: var(--text-main);
      display: flex; flex-direction: column; overflow-x: hidden;
    }

    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: #1f3a52; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    h1, h2, h3, .logo, .btn, .bubbleBtn, #sideMenu a, .login-btn-header, .side-menu-login-btn, .pop-user, .streak-txt, .coins-count { 
        font-family: 'Orbitron', sans-serif; 
    }

    /* --- ACCOUNT POPUP MODAL STYLES --- */
    .account-modal-overlay {
        position: fixed; inset: 0; background: rgba(0,0,0,0.85);
        display: none; justify-content: center; align-items: center;
        z-index: 11000; backdrop-filter: blur(10px);
    }
    .account-modal-overlay.active { display: flex; }

    .account-card {
        background: #08101b; border: 1px solid var(--primary);
        width: 90%; max-width: 380px; border-radius: 30px;
        padding: 40px 25px; text-align: center; position: relative;
        box-shadow: 0 0 50px rgba(41, 243, 255, 0.3);
        animation: jumpIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }

    @keyframes jumpIn {
        0% { transform: scale(0.3) translateY(100px); opacity: 0; }
        100% { transform: scale(1) translateY(0); opacity: 1; }
    }

    .close-pop { position: absolute; top: 15px; right: 20px; color: #fff; cursor: pointer; font-size: 24px; background: none; border: none; opacity: 0.5; transition: 0.3s; }
    .pop-img { width: 90px; height: 90px; border-radius: 50%; border: 2px solid var(--primary); margin-bottom: 12px; }
    .pop-user { font-size: 18px; color: #fff; margin: 0; }
    .pop-mail { font-size: 12px; color: var(--text-muted); margin-bottom: 20px; }

    .streak-box {
        display: inline-flex; align-items: center; gap: 8px;
        background: rgba(255, 69, 0, 0.1); border-radius: 50px;
        padding: 6px 16px; margin-bottom: 15px; border: 1px solid rgba(255, 69, 0, 0.2);
    }
    .streak-box i { color: #ff4500; font-size: 18px; animation: fireBurn 1.5s infinite; }
    .streak-txt { font-weight: 800; color: #ff4500; font-size: 13px; }

    .coins-section {
        display: flex; flex-direction: column; align-items: center; gap: 5px;
        margin-bottom: 25px; background: rgba(255, 255, 255, 0.03);
        padding: 12px; border-radius: 20px; border: 1px solid var(--glass-border);
    }
    .coins-label { font-size: 10px; color: var(--primary); text-transform: uppercase; }
    .coins-display { display: flex; align-items: center; gap: 10px; }
    .coins-icon-img { width: 30px; height: 30px; }
    .coins-count { font-size: 20px; font-weight: 900; color: #fff; }

    .btn-tasks {
        background: rgba(41, 243, 255, 0.05); border: 1px solid var(--primary); color: var(--primary);
        padding: 16px; border-radius: 18px; text-decoration: none; display: flex;
        flex-direction: column; align-items: center; gap: 5px; transition: 0.3s; margin-bottom: 15px;
    }
    .btn-tasks:hover { background: var(--primary); color: #000; }

    .btn-logout-pop {
        background: transparent; border: 1.5px solid #ff4757; color: #ff4757;
        padding: 10px 25px; border-radius: 12px; font-family: 'Orbitron'; font-weight: 700;
        cursor: pointer; transition: 0.3s; font-size: 12px; text-transform: uppercase;
    }
    .btn-logout-pop:hover { background: #ff4757; color: #fff; }

    /* --- BANNED SCREEN --- */
    #bannedOverlay {
        display: none; position: fixed; inset: 0; background: rgba(10, 0, 0, 0.98);
        z-index: 15000; flex-direction: column; justify-content: center; align-items: center; text-align: center;
    }
    .ban-icon { font-size: 80px; color: #ff4757; margin-bottom: 20px; }

    /* --- HEADER --- */
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 20px; z-index: 1000; display: flex; justify-content: center; }
    header { width: 100%; max-width: 1200px; display: flex; align-items: center; justify-content: space-between; padding: 12px 30px; background: rgba(5, 11, 20, 0.6); border: 1px solid var(--glass-border); border-radius: 100px; backdrop-filter: blur(16px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    .logo { font-weight: 900; font-size: 24px; text-decoration: none; background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    nav { display: flex; gap: 32px; align-items: center; }
    nav a { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: 0.3s; }
    nav a:hover { color: var(--primary); }
    
    .login-btn-header { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 8px; }
    .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #fff; display: none; }
    .hamburger { display: none; background: none; border: none; color: #fff; font-size: 26px; cursor: pointer; }

    /* --- SIDE MENU --- */
    #sideMenu { position: fixed; inset: 0; left: auto; width: 320px; background: #08101b; border-left: 1px solid var(--glass-border); z-index: 2000; padding: 40px 30px; transform: translateX(100%); transition: 0.4s; display: flex; flex-direction: column; }
    #sideMenu.open { transform: translateX(0); }
    .menu-links { display: flex; flex-direction: column; gap: 30px; margin-top: 40px; }
    .menu-links a { color: #fff; text-decoration: none; font-size: 22px; font-weight: 600; }
    .side-menu-login-btn { background: rgba(41, 243, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); width: 100%; padding: 15px; border-radius: 12px; margin-top: 20px; cursor: pointer; font-family: 'Orbitron'; }

    /* --- GALLERY GRID (PC: 5, MOBILE: 1) --- */
    .container { width: 100%; max-width: 1400px; margin-top: 140px; padding: 0 20px 80px; align-self: center; }
    .gallery-grid {
      display: grid;
      gap: 20px;
      width: 100%;
    }
    @media (min-width: 1024px) {
        .gallery-grid { grid-template-columns: repeat(5, 1fr); }
    }
    @media (max-width: 1023px) and (min-width: 768px) {
        .gallery-grid { grid-template-columns: repeat(3, 1fr); }
    }
    @media (max-width: 767px) {
        .gallery-grid { grid-template-columns: repeat(1, 1fr); }
        .container { margin-top: 100px; }
    }

    .gallery-img {
      width: 100%; height: 300px; object-fit: cover; border-radius: 15px;
      border: 2px solid var(--glass-border); transition: 0.3s; cursor: pointer;
    }
    .gallery-img:hover { border-color: var(--primary); transform: scale(1.03); box-shadow: 0 0 20px var(--primary-dim); }

    /* --- LIGHTBOX & FEEDBACK --- */
    .lightbox {
      display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95);
      z-index: 5000; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px; overflow-y: auto;
    }
    .lightbox-content-wrapper { 
        max-width: 900px; width: 100%; display: flex; flex-direction: column; gap: 20px; 
        animation: zoomIn 0.3s;
    }
    .lightbox-img { width: 100%; max-height: 70vh; object-fit: contain; border-radius: 10px; }
    
    /* Like/Comment UI in Lightbox */
    .interaction-area { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; }
    .action-btns { display: flex; gap: 15px; margin-bottom: 20px; }
    .vote-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: #fff; padding: 10px 20px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-family: 'Orbitron'; font-size: 14px; }
    .vote-btn.active-like { color: var(--primary); border-color: var(--primary); }
    .vote-btn.active-dislike { color: #ff4757; border-color: #ff4757; }

    .comments-section { border-top: 1px solid var(--glass-border); padding-top: 20px; }
    .comment-list { display: flex; flex-direction: column; gap: 12px; max-height: 300px; overflow-y: auto; margin-bottom: 15px; }
    .comment-item { display: flex; gap: 12px; background: rgba(255,255,255,0.03); padding: 10px; border-radius: 12px; }
    .com-pfp { width: 35px; height: 35px; border-radius: 50%; border: 1px solid var(--primary); }
    .com-content { flex: 1; }
    .com-name { font-size: 12px; font-weight: 700; color: var(--primary); font-family: 'Orbitron'; }
    .com-text { font-size: 13px; color: #eee; }
    
    .comment-input-row { display: flex; gap: 10px; }
    .com-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 10px; padding: 12px; color: #fff; font-family: 'Poppins'; }
    .com-send-btn { background: var(--primary); border: none; width: 50px; height: 50px; border-radius: 10px; cursor: pointer; color: #000; }

    .close-lightbox { position: absolute; top: 20px; right: 30px; font-size: 40px; color: #fff; cursor: pointer; }

    /* REWARD MODAL */
    .reward-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 12000; }
    .reward-modal.active { display: flex; }
    .reward-card { background: #08101b; border: 2px solid #ffd700; border-radius: 30px; padding: 40px; text-align: center; max-width: 400px; }

    footer { background: #02050a; border-top: 1px solid var(--glass-border); padding: 40px 20px; text-align: center; margin-top: auto; }
    .footer-pfp-img { width: 60px; border-radius: 50%; border: 2px solid var(--primary); }
  </style>
</head>
<body>

<!-- REWARD MODAL (SPECIAL THANK YOU) -->
<div id="rewardModal" class="reward-modal">
    <div class="reward-card">
        <h2 style="font-family:'Orbitron'; color:#ffd700;">üéâ SPECIAL THANK YOU!</h2>
        <p>Apreciem suportul tƒÉu pentru galeria noastrƒÉ!</p>
        <div style="font-size: 40px; font-weight: 900; color: #ffd700; margin: 20px 0;">üéÅ</div>
        <button class="bubbleBtn" onclick="document.getElementById('rewardModal').classList.remove('active')">√énchide</button>
    </div>
</div>

<!-- ACCOUNT MODAL -->
<div id="accountModal" class="account-modal-overlay">
    <div class="account-card">
        <button id="closeAccountPop" class="close-pop">‚úï</button>
        <img id="popUserImg" src="" class="pop-img">
        <h3 id="popUserName" class="pop-user">Utilizator</h3>
        <p id="popUserEmail" class="pop-mail">email@exemplu.com</p>

        <div class="streak-box">
            <i class="fas fa-fire"></i>
            <span class="streak-txt">Daily Streak: 0</span>
        </div>

        <div class="coins-section">
            <span class="coins-label">Puncte KSDA</span>
            <div class="coins-display">
                <img src="https://iili.io/fhc1SKQ.png" class="coins-icon-img" alt="Coins">
                <span id="popUserCoins" class="coins-count">0</span>
            </div>
        </div>

        <div class="pop-btns">
            <a href="DailyTasks.html" class="btn-tasks">
                <span style="font-family: 'Orbitron'; font-weight: 800;">DAILY TASKS</span>
                <span style="font-size: 10px; opacity: 0.7;">C√¢»ôtigƒÉ puncte »ôi recompense</span>
            </a>
            <button id="popLogoutBtn" class="btn-logout-pop">Log Out</button>
        </div>
    </div>
</div>

<!-- BANNED OVERLAY -->
<div id="bannedOverlay">
    <i class="fas fa-user-slash ban-icon"></i>
    <h1 style="color: #ff4757; font-family: 'Orbitron';">ACCES RESTRIC»öIONAT</h1>
    <p>Adresa ta IP a fost suspendatƒÉ din motive de securitate.</p>
</div>

<!-- HEADER -->
<div class="header-container">
    <header>
        <a href="index.html" class="logo">
            <img src="https://iili.io/fXvBEiB.png" alt="KSDA Logo" style="height: 40px;">
        </a>
        <nav>
            <a href="index.html">AcasƒÉ</a>
            <a href="Wall.html">Community</a>
            <a href="recenzii.html">Recenzii</a>
            <a href="galerie.html" style="color: var(--primary);">Galerie</a>
            <button id="headerLoginBtn" class="login-btn-header">
                <img id="headerUserImg" src="" class="user-avatar-small">
                <span id="headerLoginText">LOGIN</span>
            </button>
        </nav>
        <button id="menuBtn" class="hamburger">‚ò∞</button>
    </header>
</div>

<!-- SIDE MENU -->
<aside id="sideMenu">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <img src="https://iili.io/fXvBEiB.png" alt="Logo" style="height: 40px;">
        <button id="closeMenu" style="background:none; border:none; color:#fff; font-size:30px;">‚úï</button>
    </div>
    <div class="menu-links">
        <a href="index.html">AcasƒÉ</a>
        <a href="Wall.html">Community</a>
        <a href="recenzii.html">Recenzii</a>
        <a href="DailyTasks.html">Daily Tasks</a>
        <button id="mobileLoginBtn" class="side-menu-login-btn">
            <i class="fas fa-user-circle"></i> LOGIN
        </button>
    </div>
</aside>

<!-- MAIN GALLERY -->
<main class="container">
    <h1 class="metallic-title" style="font-size: clamp(30px, 6vw, 50px); text-align: center; margin-bottom: 10px;">GALERIE PORTRETE</h1>
    <p style="text-align: center; color: var(--text-muted); margin-bottom: 50px; max-width: 600px; margin-left: auto; margin-right: auto;">
        Explora»õi colec»õia noastrƒÉ de artƒÉ digitalƒÉ. Click pe orice imagine pentru a lƒÉsa o apreciere sau un comentariu.
    </p>

    <div class="gallery-grid" id="galleryGrid">
        <!-- New Images from links provided -->
        <img src="https://iili.io/fhP29Tv.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img1')">
        <img src="https://iili.io/fhPdpyJ.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img2')">
        <img src="https://iili.io/fhPdmva.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img3')">
        <img src="https://iili.io/fhPdbYg.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img4')">
        <img src="https://iili.io/fhP2HjR.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img5')">
        <img src="https://iili.io/fhP2JQp.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img6')">
        <img src="https://iili.io/fhP22CN.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img7')">
        <img src="https://iili.io/fhP2F4t.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img8')">
        <img src="https://iili.io/fhP2f3X.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img9')">
        <img src="https://iili.io/fhP2qan.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img10')">
        <img src="https://iili.io/fhP2Bvs.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img11')">
        <img src="https://iili.io/fhP2CyG.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img12')">
        <img src="https://iili.io/fhP2xj4.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img13')">
        <img src="https://iili.io/fhP2zZl.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img14')">
        <img src="https://iili.io/fhP2ouf.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img15')">
        <img src="https://iili.io/fhP2Tn2.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img16')">
        <img src="https://iili.io/fhP2uGS.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img17')">
        <img src="https://iili.io/fhP2A67.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img18')">
        <img src="https://iili.io/fhP25F9.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img19')">
        <img src="https://iili.io/fhP27ae.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img20')">
        <img src="https://iili.io/fhP2Y8u.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img21')">
        <img src="https://iili.io/fhP2luj.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img22')">
        <img src="https://iili.io/fhP20wx.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img23')">
        <img src="https://iili.io/fhP2GnV.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img24')">
        <img src="https://iili.io/fhP2MMB.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img25')">
        <img src="https://iili.io/fhP2V6P.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img26')">
        <img src="https://iili.io/fhP2XF1.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img27')">
        <img src="https://iili.io/fhP2hcF.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img28')">
        <img src="https://iili.io/fhP2N9a.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img29')">
        <img src="https://iili.io/fhP2OAJ.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img30')">
        <img src="https://iili.io/fhP2ewv.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img31')">
        <img src="https://iili.io/fhP2ktR.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img32')">
        <img src="https://iili.io/fhP2SMN.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img33')">
        <img src="https://iili.io/fhP2UPI.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img34')">
        <img src="https://iili.io/fhP24cX.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img35')">
        <img src="https://iili.io/fhP26Sn.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img36')">
        <img src="https://iili.io/fhP2i9s.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img37')">
        <img src="https://iili.io/fhP2LNf.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img38')">
        <img src="https://iili.io/fhP2sAG.jpg" class="gallery-img" onclick="openLightbox(this, 'img39')">
        <img src="https://iili.io/fhP2Qt4.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img40')">
        <img src="https://iili.io/fhP2tol.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img41')">
        <img src="https://iili.io/fhP2DV2.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img42')">
        <img src="https://iili.io/fhP2bPS.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img43')">
        <img src="https://iili.io/fhP2pK7.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img44')">
        <img src="https://iili.io/fhP2yl9.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img45')">
        <img src="https://iili.io/fhP39Se.md.jpg" class="gallery-img" onclick="openLightbox(this, 'img46')">
        <!-- Existing images should follow here -->
        <img src="https://iili.io/f0GxswB.md.jpg" class="gallery-img" onclick="openLightbox(this, 'imgOld1')">
        <img src="https://iili.io/f0GxLZP.md.jpg" class="gallery-img" onclick="openLightbox(this, 'imgOld2')">
    </div>
</main>

<!-- LIGHTBOX -->
<div id="lightbox" class="lightbox">
    <span class="close-lightbox" onclick="closeLightbox()">&times;</span>
    <div class="lightbox-content-wrapper">
        <img id="lightboxImg" src="" class="lightbox-img">
        
        <div class="interaction-area">
            <div class="action-btns">
                <button id="likeBtn" class="vote-btn"><i class="fas fa-thumbs-up"></i> <span id="likeCount">0</span></button>
                <button id="dislikeBtn" class="vote-btn"><i class="fas fa-thumbs-down"></i> <span id="dislikeCount">0</span></button>
            </div>

            <div class="comments-section">
                <h3 style="font-family: 'Orbitron'; font-size: 14px; margin-bottom: 15px;">COMENTARII</h3>
                <div id="commentList" class="comment-list">
                    <!-- Comments load here -->
                </div>
                <div class="comment-input-row">
                    <input type="text" id="comInput" class="com-input" placeholder="Scrie un comentariu...">
                    <button id="sendComBtn" class="com-send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>
    </div>
</div>

<footer>
    <div class="logo">KSDA</div>
    <div class="made-by-wrapper">
        <img src="https://iili.io/f1ddIfe.png" class="footer-pfp-img">
        <p style="font-size:12px; opacity:0.5;">&copy; 2024 KSDAPromovari</p>
    </div>
</footer>

<!-- FIREBASE LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoH80kffNrzFAcyRqsTVdifs-whUhwH9A",
      authDomain: "ksda-7546f.firebaseapp.com",
      projectId: "ksda-7546f",
      storageBucket: "ksda-7546f.firebasestorage.app",
      messagingSenderId: "306437513808",
      appId: "1:306437513808:web:28479810e3fdf71b32e755"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    let currentImgId = null;
    let userIP = null;
    fetch('https://api.ipify.org?format=json').then(r => r.json()).then(d => userIP = d.ip);

    // --- AUTH UI SYNC ---
    const headerLoginBtn = document.getElementById('headerLoginBtn');
    const headerUserImg = document.getElementById('headerUserImg');
    const headerLoginText = document.getElementById('headerLoginText');
    const accountModal = document.getElementById('accountModal');
    const mobileLoginBtn = document.getElementById('mobileLoginBtn');

    onAuthStateChanged(auth, async (user) => {
        if(user) {
            headerLoginText.innerText = "ACCOUNT";
            headerUserImg.src = user.photoURL; headerUserImg.style.display = "block";
            if(mobileLoginBtn) mobileLoginBtn.innerHTML = '<i class="fas fa-user-circle"></i> CONT';

            // Check Ban
            if(userIP) {
                const banSnap = await getDoc(doc(db, "banned_ips", userIP));
                if(banSnap.exists()) { document.getElementById('bannedOverlay').style.display = 'flex'; return; }
            }

            // Sync Data
            onSnapshot(doc(db, "accounts", user.uid), (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    document.getElementById('popUserImg').src = data.image;
                    document.getElementById('popUserName').innerText = data.username;
                    document.getElementById('popUserEmail').innerText = data.email;
                    document.getElementById('popUserCoins').innerText = data.coins || 0;
                    document.querySelector('.streak-txt').innerText = `Daily Streak: ${data.streak || 0}`;
                }
            });
        } else {
            headerLoginText.innerText = "LOGIN"; headerUserImg.style.display = "none";
            if(mobileLoginBtn) mobileLoginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> LOGIN';
        }
    });

    async function handleLogin() {
        try {
            const res = await signInWithPopup(auth, provider);
            const user = res.user;
            const userRef = doc(db, "accounts", user.uid);
            const snap = await getDoc(userRef);
            if(!snap.exists()) {
                await setDoc(userRef, { uid: user.uid, username: user.displayName, email: user.email, image: user.photoURL, coins: 250, streak: 0, ip: userIP || "unknown", joinedAt: new Date(), completedQuests: [] });
            }
        } catch(e) { console.error(e); }
    }

    headerLoginBtn.onclick = () => !auth.currentUser ? handleLogin() : accountModal.classList.add('active');
    mobileLoginBtn.onclick = () => !auth.currentUser ? handleLogin() : accountModal.classList.add('active');
    document.getElementById('closeAccountPop').onclick = () => accountModal.classList.remove('active');
    document.getElementById('popLogoutBtn').onclick = () => signOut(auth).then(() => location.reload());

    // --- LIGHTBOX INTERACTION ---
    window.openLightbox = (el, id) => {
        currentImgId = id;
        document.getElementById('lightboxImg').src = el.src;
        document.getElementById('lightbox').style.display = 'flex';
        loadImgData(id);
    };

    window.closeLightbox = () => {
        document.getElementById('lightbox').style.display = 'none';
        currentImgId = null;
    };

    async function loadImgData(id) {
        // Likes/Dislikes
        onSnapshot(doc(db, "gallery_feedback", id), (snap) => {
            const data = snap.exists() ? snap.data() : { votes: {} };
            const votes = data.votes || {};
            let l = 0, d = 0;
            Object.values(votes).forEach(v => v === 1 ? l++ : d++);
            document.getElementById('likeCount').innerText = l;
            document.getElementById('dislikeCount').innerText = d;
            
            const userVote = votes[auth.currentUser?.uid];
            document.getElementById('likeBtn').className = `vote-btn ${userVote === 1 ? 'active-like' : ''}`;
            document.getElementById('dislikeBtn').className = `vote-btn ${userVote === -1 ? 'active-dislike' : ''}`;
        });

        // Comments
        const q = query(collection(db, `gallery_feedback/${id}/comments`), orderBy("createdAt", "desc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('commentList');
            list.innerHTML = '';
            snap.forEach(docSnap => {
                const c = docSnap.data();
                list.innerHTML += `
                    <div class="comment-item">
                        <img src="${c.photo}" class="com-pfp">
                        <div class="com-content">
                            <div class="com-name">${c.name}</div>
                            <div class="com-text">${c.text}</div>
                        </div>
                    </div>`;
            });
        });
    }

    // Like Action
    document.getElementById('likeBtn').onclick = () => vote(1);
    document.getElementById('dislikeBtn').onclick = () => vote(-1);

    async function vote(val) {
        if(!auth.currentUser) return alert("LogheazƒÉ-te pentru a vota!");
        const ref = doc(db, "gallery_feedback", currentImgId);
        const snap = await getDoc(ref);
        let votes = snap.exists() ? snap.data().votes || {} : {};
        
        if(votes[auth.currentUser.uid] === val) delete votes[auth.currentUser.uid];
        else votes[auth.currentUser.uid] = val;
        
        await setDoc(ref, { votes }, { merge: true });
    }

    // Post Comment
    document.getElementById('sendComBtn').onclick = async () => {
        const input = document.getElementById('comInput');
        if(!auth.currentUser || !input.value.trim()) return;
        
        await setDoc(doc(db, `gallery_feedback/${currentImgId}/comments/${auth.currentUser.uid}_${Date.now()}`), {
            text: input.value.trim(),
            name: auth.currentUser.displayName,
            photo: auth.currentUser.photoURL,
            uid: auth.currentUser.uid,
            createdAt: serverTimestamp()
        });
        input.value = '';
        
        // Bonus for first interaction (Quest logic)
        document.getElementById('rewardModal').classList.add('active');
    };

    // --- SIDE MENU LOGIC ---
    const menuBtn = document.getElementById('menuBtn');
    const sideMenu = document.getElementById('sideMenu');
    const closeMenu = document.getElementById('closeMenu');
    menuBtn.onclick = () => sideMenu.classList.add('open');
    closeMenu.onclick = () => sideMenu.classList.remove('open');

</script>
</body>
</html>
