<!DOCTYPE html>
<html lang="ro">
<head>
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B6DWPJ4T2C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B6DWPJ4T2C');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Wall — KSDAPromovari</title>
  <link rel="icon" type="image/png" href="https://iili.io/fXks1Dv.png">
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* VARIABLES */
    :root {
      --bg-dark: #050b14;
      --primary: #29f3ff;
      --glass-bg: rgba(13, 25, 41, 0.85);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-muted: #a5b1c2;
    }
    * { box-sizing: border-box; outline: none; }
    body {
      margin: 0; min-height: 100vh; background-color: var(--bg-dark);
      background-image: linear-gradient(to bottom, rgba(5, 11, 20, 0.85), var(--bg-dark)), url('https://i.makeagif.com/media/3-03-2021/otrneG.gif');
      background-position: center; background-size: cover; background-attachment: fixed;
      font-family: 'Poppins', sans-serif; color: #fff; display: flex; flex-direction: column;
    }
    h1, h2, button { font-family: 'Orbitron', sans-serif; }

    /* LAYOUT */
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 20px; z-index: 1000; display: flex; justify-content: center; }
    header { width: 100%; max-width: 1200px; display: flex; align-items: center; justify-content: space-between; padding: 12px 30px; background: rgba(5, 11, 20, 0.6); border: 1px solid var(--glass-border); border-radius: 100px; backdrop-filter: blur(16px); }
    .logo img { height: 40px; }
    nav { display: flex; gap: 20px; align-items: center; }
    nav a { color: var(--text-muted); text-decoration: none; font-weight: 600; font-size: 13px; }
    
    .wall-container { margin-top: 140px; width: 100%; max-width: 900px; margin-left: auto; margin-right: auto; padding: 0 20px 80px; flex: 1; display: flex; flex-direction: column; align-items: center; }
    .wall-card { width: 100%; background: var(--glass-bg); border: 1px solid var(--primary); border-radius: 24px; display: flex; flex-direction: column; height: 70vh; backdrop-filter: blur(10px); overflow: hidden; }

    /* CHAT HEADER */
    .chat-header { padding: 15px 20px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .user-pfp { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--primary); }
    
    /* MESSAGES */
    .messages-feed { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    .msg-wrapper { display: flex; flex-direction: column; max-width: 80%; }
    .msg-wrapper.mine { align-self: flex-end; align-items: flex-end; }
    .msg-wrapper.theirs { align-self: flex-start; }
    .msg-bubble { padding: 10px 15px; border-radius: 15px; background: rgba(255,255,255,0.1); font-size: 14px; }
    .msg-wrapper.mine .msg-bubble { background: var(--primary); color: #000; font-weight: 500; }
    
    /* INPUT */
    .input-area-wrapper { background: rgba(0,0,0,0.6); border-top: 1px solid var(--glass-border); padding: 10px; }
    .input-row { display: flex; gap: 10px; }
    .chat-input { flex: 1; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 25px; padding: 10px 15px; color: #fff; }
    .send-btn { width: 45px; height: 45px; border-radius: 50%; background: var(--primary); border: none; cursor: pointer; }

    /* NOTIFICATION BUTTON */
    #enableNotifsBtn {
        background: rgba(41, 243, 255, 0.1);
        border: 1px solid var(--primary);
        color: var(--primary);
        padding: 5px 15px;
        border-radius: 15px;
        font-size: 11px;
        cursor: pointer;
        display: flex; align-items: center; gap: 5px;
    }
    #enableNotifsBtn:hover { background: var(--primary); color: #000; }

    /* VIEWS */
    .locked-view, .banned-view { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #fff; text-align: center; }
    .chat-view { display: none; flex-direction: column; height: 100%; }
    
    .google-btn { background: #fff; color: #000; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; display: flex; gap: 10px; align-items: center; font-weight: bold; margin-top: 20px; }
    .typing-indicator { height: 20px; padding: 0 20px; font-size: 11px; color: #aaa; font-style: italic; }
    .logout-text { color: #ff4757; cursor: pointer; font-size: 12px; text-decoration: underline; margin-left: 10px; }
  </style>
</head>
<body>

  <!-- HEADER -->
  <div class="header-container">
    <header>
      <a href="#" class="logo"><img src="https://iili.io/fXvBEiB.png" alt="Logo"></a>
      <nav>
        <a href="index.html">Acasă</a>
        <a href="wall.html" style="color:var(--primary)">Wall</a>
      </nav>
    </header>
  </div>

  <div class="wall-container">
    <h1 style="text-align:center; margin-bottom:10px;">COMMUNITY WALL</h1>
    <div class="wall-card">
        
        <!-- LOCKED (LOGOUT) STATE -->
        <div id="lockedView" class="locked-view">
            <h2>Acces Membri</h2>
            <p>Trebuie să fii logat pentru a vorbi.</p>
            <button id="loginBtn" class="google-btn">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Login cu Google
            </button>
        </div>

        <!-- BANNED STATE -->
        <div id="bannedView" class="banned-view" style="display:none;">
            <h2 style="color:#ff4757">ACCES INTERZIS</h2>
            <p>Ai fost banat permanent.</p>
        </div>

        <!-- CHAT STATE -->
        <div id="chatView" class="chat-view">
            <div class="chat-header">
                <div class="user-profile">
                    <img id="userAvatar" src="" class="user-pfp">
                    <div>
                        <span style="font-size:10px; display:block; color:var(--primary)">Logat ca</span>
                        <div id="userName" style="font-size:13px; font-weight:bold;">User</div>
                    </div>
                </div>
                <div style="display:flex; align-items:center; gap:10px;">
                    <!-- NOTIFICATION BUTTON -->
                    <button id="enableNotifsBtn"><i class="fas fa-bell"></i> Notificări</button>
                    <span id="logoutBtn" class="logout-text">Ieși</span>
                </div>
            </div>

            <div id="messagesFeed" class="messages-feed"></div>

            <div class="input-area-wrapper">
                <div id="typingIndicator" class="typing-indicator"></div>
                <div class="input-row">
                    <input type="text" id="msgInput" class="chat-input" placeholder="Scrie un mesaj..." maxlength="500">
                    <button id="sendBtn" class="send-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>
        </div>

    </div>
  </div>

  <!-- JAVASCRIPT -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, getDoc, setDoc, deleteDoc, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoH80kffNrzFAcyRqsTVdifs-whUhwH9A",
      authDomain: "ksda-7546f.firebaseapp.com",
      projectId: "ksda-7546f",
      storageBucket: "ksda-7546f.firebasestorage.app",
      messagingSenderId: "306437513808",
      appId: "1:306437513808:web:28479810e3fdf71b32e755"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // Fix Login Persistence
    setPersistence(auth, browserLocalPersistence).catch(console.error);

    const views = { locked: document.getElementById('lockedView'), chat: document.getElementById('chatView'), banned: document.getElementById('bannedView') };
    const els = {
        loginBtn: document.getElementById('loginBtn'),
        logoutBtn: document.getElementById('logoutBtn'),
        notifBtn: document.getElementById('enableNotifsBtn'),
        msgInput: document.getElementById('msgInput'),
        sendBtn: document.getElementById('sendBtn'),
        feed: document.getElementById('messagesFeed'),
        typing: document.getElementById('typingIndicator'),
        uName: document.getElementById('userName'),
        uImg: document.getElementById('userAvatar')
    };

    let currentUid = null;
    let typingTimeout = null;
    let lastNotifTime = 0;

    // Login
    els.loginBtn.onclick = () => signInWithPopup(auth, provider);
    els.logoutBtn.onclick = () => { if(confirm("Ieși din cont?")) signOut(auth); };

    // --- 1. NOTIFICATION LOGIC ---
    
    // Check permission on load
    if (Notification.permission === "granted") {
        els.notifBtn.innerHTML = '<i class="fas fa-check"></i> Testează Notificarea';
        els.notifBtn.style.opacity = "1"; 
    }

    els.notifBtn.onclick = () => {
        if (!("Notification" in window)) {
            alert("Browserul nu suportă notificări.");
            return;
        }

        if (Notification.permission === "granted") {
            // IF ALREADY GRANTED, SEND TEST NOTIFICATION
            new Notification("Test KSDA", {
                body: "✅ Notificările funcționează corect!",
                icon: "https://iili.io/fXks1Dv.png"
            });
        } else {
            // IF NOT GRANTED, ASK PERMISSION
            Notification.requestPermission().then(permission => {
                if (permission === "granted") {
                    els.notifBtn.innerHTML = '<i class="fas fa-check"></i> Testează Notificarea';
                    new Notification("KSDA Wall", {
                        body: "Ai activat notificările!",
                        icon: "https://iili.io/fXks1Dv.png"
                    });
                } else {
                    alert("Ai blocat notificările. Verifică setările browserului (lângă URL).");
                }
            });
        }
    };

    // --- 2. AUTH STATE ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUid = user.uid;
            
            views.locked.style.display = 'none';
            views.chat.style.display = 'flex';
            els.uImg.src = user.photoURL;
            els.uName.innerText = user.displayName;

            // Ensure Account Exists
            const userRef = doc(db, "accounts", user.uid);
            getDoc(userRef).then(snap => {
                if(!snap.exists()) setDoc(userRef, { uid: user.uid, username: user.displayName, email: user.email, image: user.photoURL });
            });

            loadMessages();
            listenForTypers(); 

        } else {
            currentUid = null;
            views.locked.style.display = 'flex';
            views.chat.style.display = 'none';
        }
    });

    // --- 3. TYPING LISTENER ---
    function listenForTypers() {
        const q = query(collection(db, "typing_status"));
        onSnapshot(q, (snapshot) => {
            const typers = [];
            let notifierName = "";

            snapshot.forEach(doc => {
                // IMPORTANT: You do NOT get notifications for yourself
                if(doc.id !== currentUid) {
                    typers.push(doc.data().name);
                    notifierName = doc.data().name;
                }
            });

            if (typers.length > 0) {
                els.typing.innerText = typers.length === 1 ? `${typers[0]} scrie...` : "Mai mulți scriu...";
                
                // TRIGGER NOTIFICATION
                const now = Date.now();
                // 15 seconds cooldown
                if (Notification.permission === "granted" && (now - lastNotifTime > 15000)) {
                    
                    new Notification("Cineva scrie...", {
                        body: `${notifierName} scrie un mesaj pe Wall...`,
                        icon: "https://iili.io/fXks1Dv.png",
                        tag: "typing-tag"
                    });

                    lastNotifTime = now;
                }

            } else {
                els.typing.innerText = "";
            }
        });
    }

    // --- 4. CHAT FUNCTIONS ---
    function loadMessages() {
        const q = query(collection(db, "wall_messages"), orderBy("createdAt", "desc"), limit(50));
        onSnapshot(q, (snapshot) => {
            els.feed.innerHTML = "";
            const docs = [];
            snapshot.forEach(d => docs.push({id: d.id, ...d.data()}));
            docs.reverse().forEach(msg => {
                const div = document.createElement('div');
                div.className = `msg-wrapper ${msg.uid === currentUid ? 'mine' : 'theirs'}`;
                div.innerHTML = `<div class="msg-bubble">${msg.text}</div>`;
                els.feed.appendChild(div);
            });
            els.feed.scrollTop = els.feed.scrollHeight;
        });
    }

    els.msgInput.addEventListener('input', () => {
        if(currentUid) {
            updateTyping(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => updateTyping(false), 3000);
        }
    });

    els.sendBtn.onclick = async () => {
        const txt = els.msgInput.value.trim();
        if(!txt || !currentUid) return;
        await addDoc(collection(db, "wall_messages"), {
            text: txt, uid: currentUid, name: auth.currentUser.displayName, createdAt: serverTimestamp(), isDeleted: false
        });
        els.msgInput.value = "";
        updateTyping(false);
    };

    async function updateTyping(status) {
        if(!currentUid) return;
        const ref = doc(db, "typing_status", currentUid);
        if(status) setDoc(ref, { name: auth.currentUser.displayName, timestamp: serverTimestamp() });
        else deleteDoc(ref);
    }
  </script>
</body>
</html>
