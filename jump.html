// --- ADD THIS VARIABLE AT THE TOP OF YOUR SCRIPT (with other let variables) ---
let lastEnemyY = 0; 

function createPlatform(y, forceNormal = false) {
    let type = 'NORMAL';
    let cracks = 0; 
    let enemy = null; 
    let item = null;
    const r = Math.random();

    // Count currently active (non-dead) enemies to prevent over-spawning
    let activeEnemies = platforms.filter(p => p.enemy && !p.enemy.dead).length;

    // --- NEW BALANCED DIFFICULTY TIERS ---
    let coinChance = 0.08;   // Reduced from 0.18
    let enemyChance = 0.03;  // Reduced base chance
    let maxEnemyHp = 1;

    if (score < 5000) {
        if (!forceNormal) {
            if (r > 0.95) type = 'BOOST';
            else if (score > 500 && r > 0.85) type = 'FRAGILE'; 
            else if (r > 0.90) type = 'HEAL';
            else if (r > 0.88 && score > 2000) type = 'ELEVATOR'; 
        }
        coinChance = 0.08;
        enemyChance = 0.04;
    } 
    else if (score < 10000) {
        if (!forceNormal) {
            if (r > 0.93) type = 'BOOST';
            else if (r > 0.85) type = 'FRAGILE';
            else if (r > 0.80) type = 'ELEVATOR';
        }
        coinChance = 0.10;
        enemyChance = 0.06;
        maxEnemyHp = 2;
    } 
    else {
        // HARDCORE (10k+)
        if (!forceNormal) {
            if (r > 0.92) type = 'BOOST';
            else if (r > 0.88) type = 'SPIKES_BLUE'; 
            else if (r > 0.80) type = 'FRAGILE';
        }
        coinChance = 0.12; // Even at high scores, we keep coins rarer
        enemyChance = 0.08; // Capped at 8%
        maxEnemyHp = 3;
    }

    // --- ENEMY LIMITER LOGIC ---
    // 1. Max 2 enemies on screen
    // 2. Must be at least 400 pixels away from the last enemy
    // 3. Score must be over 1000
    let canSpawnEnemy = activeEnemies < 2 && (Math.abs(y - lastEnemyY) > 400) && score > 1000;

    if (['NORMAL', 'FRAGILE', 'ELEVATOR'].includes(type) && Math.random() < enemyChance && canSpawnEnemy) {
        let hp = Math.floor(Math.random() * maxEnemyHp) + 1; 
        enemy = { 
            type: Math.floor(Math.random() * 3) + 1, 
            dead: false, 
            shootTimer: Math.random() * 30, // Randomize start timer so they don't sync shots
            hp: hp,
            maxHp: hp 
        };
        lastEnemyY = y; // Mark this Y position
    }

    // --- ITEM SPAWN LOGIC (Coins & Buffs) ---
    if (!enemy && !type.includes('SPIKES') && type !== 'BOOST') {
        let rItem = Math.random(); 

        // Buffs (Rare: 5% chance)
        if (score > 3000 && rItem < 0.05) { 
            const buffRoll = Math.random();
            if (buffRoll < 0.12)      item = 'BUFF_GHOST';    
            else if (buffRoll < 0.24) item = 'BUFF_FIRE';     
            else if (buffRoll < 0.36) item = 'BUFF_TIMESTOP'; 
            else if (buffRoll < 0.70) item = 'BUFF_HP';       
            else if (buffRoll < 0.85) item = 'BUFF_SHIELD';   
            else                      item = 'BUFF_MAGNET';   
        }
        // Diamonds (Very Rare: 3% chance)
        else if (score > 5000 && rItem < 0.03) { 
            item = 'DIAMOND'; 
        } 
        // Coins (8% - 12% depending on tier)
        else if (rItem < coinChance) { 
            item = 'COIN'; 
        }
    }

    if (type === 'FRAGILE' && Math.random() > 0.7) cracks = 1;

    return { 
        x: Math.random() * (canvas.width - PLATFORM_WIDTH), 
        y: y, startY: y, width: PLATFORM_WIDTH, 
        type: type, cracks: cracks, enemy: enemy, item: item, used: false,
        variant: Math.random() > 0.5 ? 1 : 2, offset: Math.random() * Math.PI * 2,
        itemOffsetX: 0, itemOffsetY: 0
    };
}
