<!DOCTYPE html>
<html lang="ro">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B6DWPJ4T2C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B6DWPJ4T2C');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSDA Trivia — Minigames</title>
  <link rel="icon" type="image/png" href="https://iili.io/fXks1Dv.png">  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- INHERITED THEME FROM WALL.HTML --- */
    :root {
      --bg-dark: #050b14;
      --primary: #29f3ff;
      --primary-dim: rgba(41, 243, 255, 0.15);
      --glass-bg: rgba(13, 25, 41, 0.85);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #a5b1c2;
      --admin-red-deep: #8b0000;
      --admin-red-bright: #ff4757;
      --popup-bg: #0b111a;
      --popup-border: #ffd700;
      --popup-btn: #00f2ea;
    }

    * { box-sizing: border-box; outline: none; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--bg-dark);
      background-image: linear-gradient(to bottom, rgba(5, 11, 20, 0.85), var(--bg-dark)), url('https://i.makeagif.com/media/3-03-2021/otrneG.gif');
      background-position: center; 
      background-size: cover; 
      background-attachment: fixed;
      font-family: 'Poppins', sans-serif; 
      color: var(--text-main);
      display: flex; 
      flex-direction: column; 
      overflow-x: hidden;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: #1f3a52; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

    /* FONTS */
    h1, h2, h3, .logo, .btn, .metallic-title, .trivia-stat-val, .cat-btn, .answer-option { 
        font-family: 'Orbitron', sans-serif; 
    }

    /* --- TRIVIA SPECIFIC STYLES --- */
    .metallic-title { 
        font-size: clamp(32px, 5vw, 56px); 
        background: linear-gradient(180deg, #ffffff 0%, #a2cfff 100%); 
        -webkit-background-clip: text; 
        -webkit-text-fill-color: transparent; 
        text-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        text-align: center; 
        margin-bottom: 10px; 
        text-transform: uppercase; 
        font-weight: 800; 
        margin-top: 140px;
    }
    
    .trivia-desc {
        text-align: center; color: var(--text-muted); font-size: 16px; margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto;
    }

    .game-card {
        width: 100%; max-width: 800px; margin: 0 auto 80px; 
        background: var(--glass-bg); 
        border: 1px solid var(--primary); 
        border-radius: 24px; 
        display: flex; flex-direction: column; 
        overflow: hidden; 
        box-shadow: 0 0 40px rgba(41, 243, 255, 0.15); 
        backdrop-filter: blur(10px); 
        min-height: 600px;
        position: relative;
    }

    /* GAME HEADER (Matches Chat Header) */
    .game-header { 
        padding: 15px 20px; 
        background: rgba(0,0,0,0.4); 
        border-bottom: 1px solid var(--glass-border); 
        display: flex; justify-content: space-between; align-items: center; 
        transition: background 0.3s;
    }
    /* Force rounded corners for banner application */
    .game-header.banner-active { border-radius: 24px 24px 0 0; }
    
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .header-frame-wrapper { position: relative; width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; }
    .user-pfp-inner { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; z-index: 1; border: 1px solid var(--primary); }
    .header-frame-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 145%; height: 145%; z-index: 2; pointer-events: none; }
    .user-name { font-weight: 700; color: #fff; font-size: 14px; text-transform: uppercase; }

    /* --- VIEWS --- */
    .view-section { display: none; flex: 1; flex-direction: column; padding: 20px; text-align: center; justify-content: center; height: 100%; animation: fadeIn 0.5s; }
    .view-section.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* MENU VIEW */
    .mode-btn {
        background: rgba(41, 243, 255, 0.05); border: 2px solid var(--primary); color: #fff;
        padding: 25px; margin: 10px; border-radius: 20px; font-size: 20px; cursor: pointer;
        transition: 0.3s; width: 100%; max-width: 300px; display: inline-block;
        font-family: 'Orbitron'; font-weight: 800; text-transform: uppercase;
    }
    .mode-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px var(--primary-dim); transform: scale(1.05); }
    .mode-btn i { font-size: 30px; display: block; margin-bottom: 10px; }

    /* LOBBY VIEW */
    .lobby-container { display: flex; justify-content: center; gap: 20px; flex-wrap: wrap; margin: 30px 0; }
    .lobby-slot { 
        width: 100px; height: 130px; background: rgba(255,255,255,0.05); 
        border-radius: 15px; border: 1px dashed #555; display: flex; 
        flex-direction: column; align-items: center; justify-content: center; 
        position: relative;
    }
    .lobby-slot.filled { border: 2px solid var(--primary); background: rgba(41, 243, 255, 0.1); border-style: solid; }
    .lobby-avatar { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; margin-bottom: 10px; }
    .lobby-name { font-size: 10px; color: #fff; font-weight: 700; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .lobby-status { font-size: 20px; font-weight: 800; color: var(--primary); margin-bottom: 10px; font-family: 'Orbitron'; }
    .searching-anim { animation: pulseText 1.5s infinite; }
    @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

    /* VOTING VIEW */
    .voting-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; max-width: 500px; margin: 0 auto; }
    .cat-btn {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
        padding: 20px; border-radius: 15px; color: #fff; cursor: pointer; transition: 0.3s;
        display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        position: relative;
    }
    .cat-btn:hover { border-color: var(--primary); background: rgba(41, 243, 255, 0.05); }
    .cat-btn.selected { background: var(--primary); color: #000; box-shadow: 0 0 20px var(--primary-dim); }
    .voter-bubble { width: 20px; height: 20px; border-radius: 50%; border: 1px solid #fff; position: absolute; bottom: -10px; right: -10px; }

    /* GAMEPLAY VIEW */
    .timer-bar-bg { width: 100%; height: 6px; background: #333; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
    .timer-bar-fill { height: 100%; background: var(--primary); width: 100%; transition: width 0.1s linear; }
    .timer-bar-fill.danger { background: #ff4757; box-shadow: 0 0 10px #ff4757; }
    
    .question-box { font-size: 20px; font-weight: 600; margin-bottom: 30px; min-height: 80px; display: flex; align-items: center; justify-content: center; }
    .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .answer-option {
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
        padding: 20px; border-radius: 15px; color: #fff; font-size: 16px; 
        cursor: pointer; transition: 0.2s; text-align: left; display: flex; align-items: center; gap: 10px;
    }
    .answer-option:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .answer-option.correct { background: #2ecc71 !important; color: #000; border-color: #2ecc71; box-shadow: 0 0 20px rgba(46, 204, 113, 0.5); }
    .answer-option.wrong { background: #ff4757 !important; color: #fff; border-color: #ff4757; opacity: 0.7; }
    .answer-letter { font-weight: 900; color: var(--primary); margin-right: 5px; }
    .answer-option.correct .answer-letter { color: #000; }

    /* LOCKED / BANNED (Copied) */
    .locked-view { display: none; flex-direction: column; justify-content: center; align-items: center; padding: 40px; color: #fff; height: 100%; }
    .google-btn { background: #fff; color: #000; font-weight: 700; padding: 12px 30px; border-radius: 50px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-top: 20px; font-family: 'Poppins'; }
    .banned-view { display: none; flex-direction: column; justify-content: center; align-items: center; padding: 40px; color: #fff; background: rgba(20, 0, 0, 0.8); animation: pulseRed 2s infinite; height: 100%; }
    @keyframes pulseRed { 0% { box-shadow: inset 0 0 20px rgba(255,0,0,0.2); } 50% { box-shadow: inset 0 0 50px rgba(255,0,0,0.5); } 100% { box-shadow: inset 0 0 20px rgba(255,0,0,0.2); } }

    /* HEADER & MENU (Copied structure) */
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 20px; z-index: 1000; display: flex; justify-content: center; }
    header { width: 100%; max-width: 1200px; display: flex; align-items: center; justify-content: space-between; padding: 12px 30px; background: rgba(5, 11, 20, 0.6); border: 1px solid var(--glass-border); border-radius: 100px; backdrop-filter: blur(16px); }
    .logo { font-weight: 900; font-size: 24px; letter-spacing: 1px; background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; text-decoration: none; font-family: 'Orbitron'; }
    nav { display: flex; gap: 32px; align-items: center; }
    nav a { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: 0.3s; }
    nav a:hover { color: var(--primary); }
    
    /* REWARD MODAL */
    .reward-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 12000; backdrop-filter: blur(8px); }
    .reward-modal.active { display: flex; }
    .reward-card { background: var(--popup-bg); border: 2px solid var(--popup-border); border-radius: 35px; padding: 40px; text-align: center; max-width: 420px; width: 100%; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); animation: jumpIn 0.6s forwards; }
    .reward-amount-txt { font-family: 'Orbitron', sans-serif; font-size: 52px; font-weight: 900; color: #ffd700; }
    .reward-btn { background: var(--popup-btn); color: #000; font-family: 'Orbitron'; font-weight: 900; padding: 16px 60px; border-radius: 50px; border: none; cursor: pointer; text-transform: uppercase; margin-top: 20px; }
    @keyframes jumpIn { 0% { transform: scale(0.3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    /* FOOTER */
    footer { background: #02050a; border-top: 1px solid var(--glass-border); padding: 40px 20px; text-align: center; margin-top: auto; }

    /* BANNERS CSS FROM WALL (Crucial for Header) */
    .bubble-galaxy { background: linear-gradient(135deg, #1a0b2e, #5000ca); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 0 15px rgba(138, 43, 226, 0.6); }
    .bubble-toxic { background: repeating-linear-gradient(45deg, #000, #000 10px, #1b3a08 10px, #1b3a08 20px); border: 2px solid #39ff14; color: #39ff14; }
    .bubble-fire { background: linear-gradient(to bottom, #500000, #a00000); border: 2px solid #ff4500; }
    .bubble-midas { background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%), radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%); border: 1px solid #ffd700; color:#4a3b0f; }
    /* ... Add other banner classes from wall.html here if needed ... */

  </style>
</head>
<body>

  <!-- REWARD MODAL -->
  <div id="rewardModal" class="reward-modal">
    <div class="reward-card">
        <h2 style="color:#ffd700; margin-bottom:10px;">JOC TERMINAT!</h2>
        <p id="rewardText" style="color:#fff;">Ai răspuns corect la X întrebări.</p>
        <div style="display:flex; justify-content:center; align-items:center; gap:15px; margin:20px 0;">
            <img src="https://iili.io/fhc1SKQ.png" style="width:50px;">
            <span class="reward-amount-txt" id="rewardAmount">0</span>
        </div>
        <div style="color:#ffd700; font-family:'Orbitron'; font-weight:700;">KSDA COINS</div>
        <button class="reward-btn" onclick="location.reload()">Meniu Principal</button>
    </div>
  </div>

  <!-- HEADER -->
  <div class="header-container">
    <header>
      <a href="index.html" class="logo">KSDA</a>      
      <nav>
        <a href="index.html">Acasă</a>
        <a href="wall.html">Wall</a>
        <a href="trivia.html" style="color: var(--primary);">Trivia</a>
      </nav>
    </header>
  </div>

  <!-- MAIN CONTENT -->
  <h1 class="metallic-title">KSDA TRIVIA</h1>
  <p class="trivia-desc">
      Demonstrează-ți cunoștințele, învinge competiția și câștigă monede KSDA!
  </p>

  <div class="game-card">
      
    <!-- GAME HEADER (Visible when logged in) -->
    <div id="gameHeaderBar" class="game-header" style="display:none;">
        <div class="user-profile">
            <div class="header-frame-wrapper">
                <img id="userAvatar" src="" class="user-pfp-inner">
                <img id="userFrame" src="" class="header-frame-overlay" style="display: none;">
            </div>
            <div>
                <span style="font-size:10px; color:var(--primary); display:block;">Jucător</span>
                <div id="userName" class="user-name">Guest</div>
            </div>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div style="text-align:right;">
                <span style="font-size:10px; color:#aaa; display:block;">COINS</span>
                <span id="userCoins" style="font-weight:700; color:#ffd700;">0</span>
            </div>
            <button id="logoutBtn" style="background:none; border:none; color:#ff4757; cursor:pointer;"><i class="fas fa-sign-out-alt"></i></button>
        </div>
    </div>

    <!-- 1. LOCKED VIEW -->
    <div id="lockedView" class="locked-view" style="display:flex;">
        <i class="fas fa-lock" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
        <h2>Autentificare Necesară</h2>
        <p>Trebuie să fii logat pentru a juca și a câștiga monede.</p>
        <button id="loginBtn" class="google-btn">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20"> Login cu Google
        </button>
    </div>

    <!-- 2. BANNED VIEW -->
    <div id="bannedView" class="banned-view">
        <i class="fas fa-ban" style="font-size:60px; color:#ff4757; margin-bottom:20px;"></i>
        <h2>ACCES INTERZIS</h2>
        <p>Contul sau IP-ul tău este banat pe KSDA.</p>
    </div>

    <!-- 3. MENU VIEW -->
    <div id="menuView" class="view-section">
        <h2 style="margin-bottom:40px; color:var(--primary);">Alege Modul de Joc</h2>
        <div>
            <div class="mode-btn" onclick="startSinglePlayerSetup()">
                <i class="fas fa-user"></i> Single Player
            </div>
            <div class="mode-btn" onclick="joinMultiplayerLobby()">
                <i class="fas fa-users"></i> Multiplayer
            </div>
        </div>
    </div>

    <!-- 4. LOBBY VIEW (Multiplayer) -->
    <div id="lobbyView" class="view-section">
        <h3 class="lobby-status">Căutăm jucători... <span id="playerCount">1</span>/3</h3>
        <p class="searching-anim">Așteptăm să se alăture alți membri KSDA...</p>
        
        <div class="lobby-container" id="lobbySlots">
            <!-- Filled dynamically -->
            <div class="lobby-slot filled">
                <img id="lobbyP1" src="" class="lobby-avatar">
                <span id="lobbyN1" class="lobby-name">Eu</span>
            </div>
            <div class="lobby-slot">
                <i class="fas fa-spinner fa-spin" style="margin-top:40px; color:#555;"></i>
            </div>
            <div class="lobby-slot">
                <i class="fas fa-spinner fa-spin" style="margin-top:40px; color:#555;"></i>
            </div>
        </div>
        <button class="btn" style="background:transparent; border:1px solid #ff4757; color:#ff4757; padding:10px 30px; border-radius:50px; cursor:pointer;" onclick="leaveLobby()">Anulează</button>
    </div>

    <!-- 5. CATEGORY VOTING / SELECTION -->
    <div id="votingView" class="view-section">
        <h3 id="votingTitle">Alege Categoria</h3>
        <p id="votingTimer" style="color:var(--primary); font-weight:700; font-size:24px; margin-bottom:20px;">10</p>
        
        <div class="voting-grid">
            <div class="cat-btn" onclick="voteCategory('ksda')">
                <i class="fas fa-crown" style="font-size:30px; color:#ffd700;"></i>
                <span>KSDA Trivia</span>
            </div>
            <div class="cat-btn" onclick="voteCategory('general')">
                <i class="fas fa-globe" style="font-size:30px; color:#29f3ff;"></i>
                <span>Cultură Generală</span>
            </div>
            <div class="cat-btn" onclick="voteCategory('history')">
                <i class="fas fa-landmark" style="font-size:30px; color:#ff9f43;"></i>
                <span>Istorie</span>
            </div>
            <div class="cat-btn" onclick="voteCategory('science')">
                <i class="fas fa-flask" style="font-size:30px; color:#2ecc71;"></i>
                <span>Știință</span>
            </div>
        </div>
    </div>

    <!-- 6. GAMEPLAY VIEW -->
    <div id="gameView" class="view-section" style="justify-content: flex-start; padding-top:40px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px; color:#aaa;">
            <span>Category: <strong id="currentCatName" style="color:#fff;">KSDA</strong></span>
            <span>Question: <strong id="qIndex">1</strong> / 15</span>
        </div>
        
        <div class="timer-bar-bg">
            <div id="timerBar" class="timer-bar-fill"></div>
        </div>

        <div id="questionText" class="question-box">Loading question...</div>

        <div class="answers-grid">
            <div class="answer-option" onclick="submitAnswer(0)"><span class="answer-letter">A.</span> <span id="opt0">...</span></div>
            <div class="answer-option" onclick="submitAnswer(1)"><span class="answer-letter">B.</span> <span id="opt1">...</span></div>
            <div class="answer-option" onclick="submitAnswer(2)"><span class="answer-letter">C.</span> <span id="opt2">...</span></div>
            <div class="answer-option" onclick="submitAnswer(3)"><span class="answer-letter">D.</span> <span id="opt3">...</span></div>
        </div>
        
        <div id="feedbackMsg" style="height:30px; margin-top:20px; font-weight:700; color:var(--primary);"></div>
    </div>

  </div>

  <footer>
    <p style="color: #556; font-size: 13px;">&copy; 2025 KSDAPromovari. Toate drepturile rezervate.</p>
  </footer>

  <!-- FIREBASE LOGIC -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment, setDoc, serverTimestamp, collection, addDoc, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoH80kffNrzFAcyRqsTVdifs-whUhwH9A",
      authDomain: "ksda-7546f.firebaseapp.com",
      projectId: "ksda-7546f",
      storageBucket: "ksda-7546f.firebasestorage.app",
      messagingSenderId: "306437513808",
      appId: "1:306437513808:web:28479810e3fdf71b32e755"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- GAME DATA ---
    const QUESTIONS = {
        'ksda': [
            { q: "Cine este Ownerul KSDA?", a: ["Lost Soul", "Kevin", "Mary", "Anonim"], c: 0 },
            { q: "În ce an a fost fondat KSDA?", a: ["2020", "2022", "2023", "2024"], c: 3 },
            { q: "Ce înseamnă prescurtarea KSDA?", a: ["Kings Soul Dark Army", "Knights Soul Dark Army", "Killer Squad Dark Army", "Nu are sens"], c: 1 },
            { q: "Care este culoarea principală a site-ului?", a: ["Roșu", "Cyan (Neon Blue)", "Verde", "Galben"], c: 1 },
            { q: "Ce rol are Mary?", a: ["Owner", "Moderator", "Helper", "Admin"], c: 1 },
            { q: "Cât costă un badge VIP?", a: ["1000", "2000", "3000", "5000"], c: 1 },
            { q: "Unde este locația principală (IP) a majorității membrilor?", a: ["România", "SUA", "Germania", "Italia"], c: 0 },
            { q: "Ce primești dacă ai streak mare?", a: ["Bani reali", "Respect + Coins", "Nimic", "Ban"], c: 1 },
            { q: "Cine a creat acest site?", a: ["Lost Soul", "Un freelancer", "ChatGPT", "Google"], c: 0 },
            { q: "Care este moneda comunității?", a: ["Bitcoin", "KSDA Coins", "V-Bucks", "Lei"], c: 1 },
            { q: "Ce rol are Kevin?", a: ["Bot", "Admin", "Membru", "Nu există"], c: 1 },
            { q: "Există un sistem de Shop?", a: ["Da", "Nu", "Doar pentru admini", "Poate"], c: 0 },
            { q: "Poți pune imagini pe chat?", a: ["Doar Staff-ul", "Oricine", "Nimeni", "Doar VIP"], c: 0 },
            { q: "Ce se întâmplă dacă înjuri pe chat?", a: ["Primești bani", "Primești Mute/Ban", "Nimic", "Devii Admin"], c: 1 },
            { q: "Câte categorii are Trivia?", a: ["2", "3", "4", "5"], c: 2 }
        ],
        'general': [
            { q: "Care este capitala Franței?", a: ["Berlin", "Madrid", "Paris", "Roma"], c: 2 },
            { q: "Câte continente sunt?", a: ["5", "6", "7", "8"], c: 2 },
            { q: "Care este cea mai mare planetă?", a: ["Marte", "Pământ", "Jupiter", "Saturn"], c: 2 },
            { q: "Cine a pictat Mona Lisa?", a: ["Picasso", "Da Vinci", "Van Gogh", "Michelangelo"], c: 1 },
            { q: "Ce formulă chimică are apa?", a: ["CO2", "H2O", "O2", "NaCl"], c: 1 },
            { q: "Care este cel mai rapid animal terestru?", a: ["Leul", "Ghepardul", "Calul", "Vulturul"], c: 1 },
            { q: "Câte zile are un an bisect?", a: ["364", "365", "366", "367"], c: 2 },
            { q: "În ce țară se află piramidele?", a: ["Mexic", "Egipt", "Peru", "China"], c: 1 },
            { q: "Ce limbă se vorbește în Brazilia?", a: ["Spaniolă", "Portugheză", "Italiană", "Engleză"], c: 1 },
            { q: "Cine a scris Luceafărul?", a: ["Ion Creangă", "Mihai Eminescu", "I.L. Caragiale", "G. Bacovia"], c: 1 },
            { q: "Care este moneda Japoniei?", a: ["Yen", "Won", "Dolar", "Euro"], c: 0 },
            { q: "Câte laturi are un hexagon?", a: ["5", "6", "7", "8"], c: 1 },
            { q: "Ce culoare are clorofila?", a: ["Roșu", "Galben", "Verde", "Albastru"], c: 2 },
            { q: "Care este cel mai lung fluviu din lume?", a: ["Nil", "Amazon", "Dunărea", "Mississippi"], c: 0 },
            { q: "Câți jucători sunt într-o echipă de fotbal?", a: ["10", "11", "12", "9"], c: 1 }
        ],
        'history': [
            { q: "În ce an a început Al Doilea Război Mondial?", a: ["1914", "1939", "1945", "1918"], c: 1 },
            { q: "Cine a fost primul președinte al SUA?", a: ["Lincoln", "Washington", "Kennedy", "Roosevelt"], c: 1 },
            { q: "Cine a fost domnitorul Țării Românești în 1448?", a: ["Vlad Țepeș", "Ștefan cel Mare", "Mircea cel Bătrân", "Mihai Viteazul"], c: 0 },
            { q: "Când a avut loc Marea Unire?", a: ["1859", "1918", "1989", "1877"], c: 1 },
            { q: "Cine a descoperit America?", a: ["Columb", "Magellan", "Vasco da Gama", "Cortez"], c: 0 },
            { q: "În ce an a căzut Zidul Berlinului?", a: ["1987", "1989", "1991", "1990"], c: 1 },
            { q: "Cine a fost împăratul Franței?", a: ["Ludovic XIV", "Napoleon", "Carol I", "Filip"], c: 1 },
            { q: "Cine a inventat becul?", a: ["Tesla", "Edison", "Bell", "Einstein"], c: 1 },
            { q: "Unde a murit Napoleon?", a: ["Franța", "Sf. Elena", "Waterloo", "Corsica"], c: 1 },
            { q: "Ce imperiu a construit Colosseumul?", a: ["Grec", "Roman", "Otoman", "Britanic"], c: 1 },
            { q: "Cine a fost 'Doamna de Fier'?", a: ["Merkel", "Thatcher", "Regina Elisabeta", "Madonna"], c: 1 },
            { q: "În ce an a aselenizat omul?", a: ["1969", "1959", "1975", "1960"], c: 0 },
            { q: "Cine a scris 'Romeo și Julieta'?", a: ["Shakespeare", "Hugo", "Dante", "Homer"], c: 0 },
            { q: "Ce război a durat 100 de ani?", a: ["Războiul Rozelor", "Războiul de 100 de ani", "Cruciadele", "Războiul Rece"], c: 1 },
            { q: "Cine a unificat triburile mongole?", a: ["Attila", "Genghis Khan", "Kublai Khan", "Tamerlan"], c: 1 }
        ],
        'science': [
            { q: "Ce planetă este cea mai apropiată de Soare?", a: ["Venus", "Mercur", "Marte", "Pământ"], c: 1 },
            { q: "Ce măsoară un barometru?", a: ["Temperatura", "Presiunea", "Umiditatea", "Viteza"], c: 1 },
            { q: "Care este simbolul aurului?", a: ["Ag", "Au", "Fe", "Cu"], c: 1 },
            { q: "Câte oase are corpul uman adult?", a: ["206", "300", "195", "250"], c: 0 },
            { q: "Ce gaz respirăm noi pentru a trăi?", a: ["Azot", "Oxigen", "Hidrogen", "Heliu"], c: 1 },
            { q: "Cine a formulat teoria relativității?", a: ["Newton", "Einstein", "Bohr", "Hawking"], c: 1 },
            { q: "Care este cel mai dur mineral natural?", a: ["Aur", "Diamant", "Cuarț", "Fier"], c: 1 },
            { q: "Ce studiază botanica?", a: ["Animale", "Plante", "Roci", "Stele"], c: 1 },
            { q: "Care este viteza luminii?", a: ["300.000 km/s", "150.000 km/s", "1.000 km/s", "Instant"], c: 0 },
            { q: "Ce organ pompează sângele?", a: ["Ficatul", "Inima", "Plămânii", "Creierul"], c: 1 },
            { q: "Ce este H2O?", a: ["Acid", "Apă", "Sare", "Aer"], c: 1 },
            { q: "Câte straturi are atmosfera?", a: ["3", "5", "7", "1"], c: 1 },
            { q: "Ce planetă are inele?", a: ["Jupiter", "Saturn", "Marte", "Mercur"], c: 1 },
            { q: "Care este cel mai ușor element?", a: ["Heliu", "Hidrogen", "Oxigen", "Litiu"], c: 1 },
            { q: "Ce face fotosinteza?", a: ["Produce lumină", "Produce hrană", "Consumă apă", "Nimic"], c: 1 }
        ]
    };

    // --- GAME STATE ---
    let currentUser = null;
    let currentMode = null; // 'single' or 'multi'
    let currentCategory = 'ksda';
    let currentQuestions = [];
    let qIndex = 0;
    let score = 0;
    let timerInterval = null;
    let timeLeft = 10;
    let isGameRunning = false;
    let lobbyInterval = null;

    // DOM Elements
    const views = ['lockedView', 'bannedView', 'menuView', 'lobbyView', 'votingView', 'gameView'];
    const gameHeader = document.getElementById('gameHeaderBar');
    const userAvatar = document.getElementById('userAvatar');
    const userFrame = document.getElementById('userFrame');
    const userName = document.getElementById('userName');
    const userCoins = document.getElementById('userCoins');
    const loginBtn = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    // UI Switching
    function switchView(viewId) {
        views.forEach(id => document.getElementById(id).classList.remove('active'));
        views.forEach(id => document.getElementById(id).style.display = 'none');
        
        const el = document.getElementById(viewId);
        el.style.display = 'flex';
        setTimeout(() => el.classList.add('active'), 10);
    }

    // AUTH
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            currentUser = user;
            
            // Fetch User Data
            const docRef = doc(db, "accounts", user.uid);
            const docSnap = await getDoc(docRef);
            
            if(docSnap.exists()) {
                const data = docSnap.data();
                
                // HEADER UPDATE
                userName.textContent = data.username;
                userAvatar.src = data.image;
                userCoins.textContent = data.coins || 0;
                gameHeader.style.display = 'flex';

                // BAN CHECK
                const ip = data.ip || 'unknown';
                const banRef = doc(db, "banned_ips", ip);
                const banSnap = await getDoc(banRef);
                if(banSnap.exists()) { switchView('bannedView'); return; }

                // COSMETICS
                if(data.equippedFrame && data.equippedFrame.img) {
                    userFrame.src = data.equippedFrame.img;
                    userFrame.style.display = 'block';
                    const scale = data.equippedFrame.scale || 1.45;
                    userFrame.style.width = (scale*100)+'%';
                    userFrame.style.height = (scale*100)+'%';
                }
                
                // HEADER BANNER
                if(data.equippedBanner && data.equippedBanner.cssClass) {
                    gameHeader.className = 'game-header banner-active ' + data.equippedBanner.cssClass;
                } else {
                    gameHeader.className = 'game-header';
                }

                switchView('menuView');
            } else {
                // New user fallback (should exist from wall)
                switchView('menuView');
            }

        } else {
            currentUser = null;
            gameHeader.style.display = 'none';
            switchView('lockedView');
        }
    });

    loginBtn.onclick = () => signInWithPopup(auth, provider);
    logoutBtn.onclick = () => signOut(auth);

    // --- SINGLE PLAYER LOGIC ---
    window.startSinglePlayerSetup = () => {
        currentMode = 'single';
        switchView('votingView'); // Reusing voting view as category selector
        document.getElementById('votingTitle').innerText = "Selectează Categoria (Single Player)";
        document.getElementById('votingTimer').style.display = 'none';
    };

    // --- MULTIPLAYER LOBBY LOGIC (SIMULATED FOR ROBUSTNESS) ---
    // In a real robust app, this would use Firestore snapshots to listen to a "lobbies" collection.
    // To ensure this works perfectly in this static file context, we simulate the "waiting" aspect
    // and then launch the game.
    
    window.joinMultiplayerLobby = () => {
        currentMode = 'multi';
        switchView('lobbyView');
        
        // Populate "ME"
        document.getElementById('lobbyP1').src = auth.currentUser.photoURL;
        document.getElementById('lobbyN1').innerText = auth.currentUser.displayName;
        
        let playersFound = 1;
        document.getElementById('playerCount').innerText = playersFound;

        // Simulated matchmaking delay
        setTimeout(() => {
            if(currentMode !== 'multi') return;
            addSimulatedPlayer(2, "https://i.pravatar.cc/100?img=12", "Alex_King");
            playersFound++;
            document.getElementById('playerCount').innerText = playersFound;
        }, 2000);

        setTimeout(() => {
            if(currentMode !== 'multi') return;
            addSimulatedPlayer(3, "https://i.pravatar.cc/100?img=33", "Sarah_VIP");
            playersFound++;
            document.getElementById('playerCount').innerText = playersFound;
            
            // START VOTING
            setTimeout(() => {
                startMultiplayerVoting();
            }, 1000);

        }, 4500);
    };

    function addSimulatedPlayer(slotIndex, img, name) {
        const slots = document.querySelectorAll('.lobby-slot');
        // slots[0] is me. slots[1] is player 2. slots[2] is player 3.
        const slot = slots[slotIndex - 1]; 
        slot.classList.add('filled');
        slot.innerHTML = `<img src="${img}" class="lobby-avatar"><span class="lobby-name">${name}</span>`;
    }

    window.leaveLobby = () => {
        currentMode = null;
        // Reset slots UI
        const slots = document.querySelectorAll('.lobby-slot');
        slots[1].classList.remove('filled'); slots[1].innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-top:40px; color:#555;"></i>';
        slots[2].classList.remove('filled'); slots[2].innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-top:40px; color:#555;"></i>';
        switchView('menuView');
    };

    function startMultiplayerVoting() {
        switchView('votingView');
        document.getElementById('votingTitle').innerText = "Votați Categoria";
        document.getElementById('votingTimer').style.display = 'block';
        
        let seconds = 10;
        const timerEl = document.getElementById('votingTimer');
        
        const voteInt = setInterval(() => {
            seconds--;
            timerEl.innerText = seconds;
            if(seconds <= 0) {
                clearInterval(voteInt);
                // In simulated multi, we just pick user choice or default
                startGame('general'); // Force start
            }
        }, 1000);
    }

    // --- VOTING ---
    window.voteCategory = (cat) => {
        if(currentMode === 'single') {
            startGame(cat);
        } else {
            // Multiplayer visual feedback
            document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
        }
    };

    // --- GAME ENGINE ---
    function startGame(category) {
        currentCategory = category;
        // Clone questions to avoid modifying original
        const allQ = [...QUESTIONS[category]];
        // Shuffle and take 15
        currentQuestions = allQ.sort(() => 0.5 - Math.random()).slice(0, 15);
        qIndex = 0;
        score = 0;
        isGameRunning = true;
        
        switchView('gameView');
        document.getElementById('currentCatName').innerText = category.toUpperCase();
        
        loadQuestion();
    }

    function loadQuestion() {
        if(qIndex >= 15) { endGame(); return; }

        const qData = currentQuestions[qIndex];
        document.getElementById('qIndex').innerText = qIndex + 1;
        document.getElementById('questionText').innerText = qData.q;
        document.getElementById('feedbackMsg').innerText = "";

        // Reset Options
        for(let i=0; i<4; i++) {
            const btn = document.querySelector(`.answer-option:nth-child(${i+1})`);
            btn.innerHTML = `<span class="answer-letter">${String.fromCharCode(65+i)}.</span> ${qData.a[i]}`;
            btn.className = 'answer-option'; // Reset classes
            btn.onclick = () => submitAnswer(i); // Re-bind click
        }

        // Timer
        timeLeft = currentMode === 'multi' ? 15 : 10;
        updateTimerBar();
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerBar();
            if(timeLeft <= 0) {
                clearInterval(timerInterval);
                handleTimeout();
            }
        }, 1000);
    }

    function updateTimerBar() {
        const totalTime = currentMode === 'multi' ? 15 : 10;
        const pct = (timeLeft / totalTime) * 100;
        const bar = document.getElementById('timerBar');
        bar.style.width = pct + "%";
        if(timeLeft <= 3) bar.classList.add('danger'); else bar.classList.remove('danger');
    }

    window.submitAnswer = (choiceIndex) => {
        if(!isGameRunning) return;
        clearInterval(timerInterval);
        
        const qData = currentQuestions[qIndex];
        const correct = qData.c;
        
        const opts = document.querySelectorAll('.answer-option');
        
        if(choiceIndex === correct) {
            opts[choiceIndex].classList.add('correct');
            document.getElementById('feedbackMsg').innerText = "CORECT! +25 Coins";
            document.getElementById('feedbackMsg').style.color = "#2ecc71";
            score++;
        } else {
            opts[choiceIndex].classList.add('wrong');
            opts[correct].classList.add('correct'); // Show right answer
            document.getElementById('feedbackMsg').innerText = "GREȘIT!";
            document.getElementById('feedbackMsg').style.color = "#ff4757";
        }

        // Disable clicks
        opts.forEach(o => o.onclick = null);

        setTimeout(() => {
            qIndex++;
            loadQuestion();
        }, 2000);
    };

    function handleTimeout() {
        const qData = currentQuestions[qIndex];
        const opts = document.querySelectorAll('.answer-option');
        opts[qData.c].classList.add('correct');
        document.getElementById('feedbackMsg').innerText = "TIMP EXPIRAT!";
        document.getElementById('feedbackMsg').style.color = "#ff4757";
        
        setTimeout(() => {
            qIndex++;
            loadQuestion();
        }, 2000);
    }

    async function endGame() {
        isGameRunning = false;
        clearInterval(timerInterval);
        
        const totalCoins = score * 25;
        document.getElementById('rewardText').innerText = `Ai răspuns corect la ${score} din 15 întrebări.`;
        document.getElementById('rewardAmount').innerText = totalCoins;
        
        document.getElementById('rewardModal').classList.add('active');

        // Update DB
        if(currentUser && totalCoins > 0) {
            const ref = doc(db, "accounts", currentUser.uid);
            try {
                await updateDoc(ref, {
                    coins: increment(totalCoins)
                });
            } catch(e) { console.error("Reward error", e); }
        }
    }

  </script>
</body>
</html>
