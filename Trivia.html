<!DOCTYPE html>
<html lang="ro">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B6DWPJ4T2C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B6DWPJ4T2C');
  </script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Trivia KSDA ‚Äî KSDAPromovari</title>
  <meta name="description" content="JoacƒÉ Trivia »ôi c√¢»ôtigƒÉ monede KSDA!">
  <link rel="icon" type="image/png" href="https://iili.io/fXks1Dv.png">

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* --- REUSING CORE VARIABLES & THEME FROM INDEX --- */
    :root {
      --bg-dark: #050b14;
      --primary: #29f3ff;
      --primary-dim: rgba(41, 243, 255, 0.15);
      --secondary: #7000ff;
      --text-main: #ffffff;
      --text-muted: #a5b1c2;
      --glass-bg: rgba(13, 25, 41, 0.7);
      --glass-border: rgba(255, 255, 255, 0.08);
      --card-radius: 24px;
      --transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --gold: #ffd700;
      --error: #ff4757;
      --success: #2ecc71;
    }

    * { box-sizing: border-box; outline: none; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0;
      min-height: 100vh;
      background-color: var(--bg-dark);
      background-image: 
        linear-gradient(to bottom, rgba(5, 11, 20, 0.85), var(--bg-dark)),
        url('https://i.makeagif.com/media/3-03-2021/otrneG.gif');
      background-position: center;
      background-size: cover;
      background-attachment: fixed;
      font-family: 'Poppins', sans-serif;
      color: var(--text-main);
      overflow-x: hidden;
    }

    h1, h2, h3, .btn, .metallic-text { font-family: 'Orbitron', sans-serif; }

    /* --- HEADER STYLES --- */
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 20px; z-index: 1000; display: flex; justify-content: center; }
    header { width: 100%; max-width: 1200px; display: flex; align-items: center; justify-content: space-between; padding: 10px 30px; background: rgba(5, 11, 20, 0.6); border: 1px solid var(--glass-border); border-radius: 100px; backdrop-filter: blur(16px); }
    .logo img { height: 40px; vertical-align: middle; }
    nav { display: flex; gap: 32px; align-items: center; }
    nav a { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: var(--transition); }
    nav a:hover { color: var(--primary); }
    .login-btn-header { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #fff; display: none; }
    
    /* --- GAME PAGE SPECIFIC STYLES --- */
    .game-section {
        padding: 120px 20px 60px;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    /* Big Metallic Text */
    .metallic-title-big {
        font-size: clamp(32px, 5vw, 64px);
        font-weight: 900;
        text-transform: uppercase;
        background: linear-gradient(180deg, #ffffff 0%, #a2cfff 50%, #5d6d7e 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 0 10px 30px rgba(0,0,0,0.5);
        margin-bottom: 10px;
        letter-spacing: 2px;
        text-align: center;
    }
    .game-desc {
        color: var(--text-muted);
        max-width: 600px;
        text-align: center;
        margin-bottom: 40px;
    }

    /* --- GAME CONTAINER (THE BOX) --- */
    .game-container {
        width: 100%;
        max-width: 700px;
        background: rgba(8, 16, 27, 0.9);
        border: 1px solid var(--glass-border);
        border-radius: 20px;
        overflow: hidden;
        box-shadow: 0 0 50px rgba(41, 243, 255, 0.1);
        position: relative;
        min-height: 400px;
        display: flex;
        flex-direction: column;
    }

    /* Header inside Box (Banner Style) */
    .game-header {
        background: #111d2d; /* Default fallback */
        padding: 15px 20px;
        border-bottom: 1px solid rgba(255,255,255,0.1);
        display: flex;
        align-items: center;
        gap: 15px;
        min-height: 70px;
    }
    /* Classes for banners will be injected here via JS (e.g., .bubble-galaxy) */
    
    .gh-pfp { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; }
    .gh-info { flex: 1; }
    .gh-name { font-family: 'Orbitron'; font-weight: 700; font-size: 14px; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }
    .gh-badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: rgba(0,0,0,0.5); color: #fff; border: 1px solid rgba(255,255,255,0.3); display: inline-block; margin-top: 2px; }

    /* Content Area */
    .game-content {
        padding: 30px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        text-align: center;
        position: relative;
    }

    /* LOCKED STATE */
    .locked-view {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100%;
        width: 100%;
    }
    .lock-icon { font-size: 60px; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 0 10px var(--primary)); }
    .lock-title { font-family: 'Orbitron'; font-size: 24px; color: #fff; margin-bottom: 10px; text-transform: uppercase; }
    .lock-text { color: var(--text-muted); font-size: 14px; margin-bottom: 20px; max-width: 80%; }
    
    /* MODE SELECTION */
    .mode-select-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
    .mode-card {
        background: rgba(255,255,255,0.03);
        border: 1px solid var(--glass-border);
        border-radius: 15px;
        padding: 30px 10px;
        cursor: pointer;
        transition: 0.3s;
    }
    .mode-card:hover { background: rgba(41, 243, 255, 0.1); border-color: var(--primary); transform: translateY(-5px); }
    .mode-icon { font-size: 40px; color: var(--primary); margin-bottom: 15px; display: block; }
    .mode-title { font-family: 'Orbitron'; font-size: 16px; font-weight: 700; color: #fff; }
    .mode-locked { opacity: 0.5; cursor: not-allowed; position: relative; }
    .mode-locked::after { content: '√éN CUR√ÇND'; position: absolute; top: 10px; right: 10px; font-size: 8px; background: #ff4757; color: #fff; padding: 2px 5px; border-radius: 4px; font-family: 'Orbitron'; }

    /* CATEGORY SELECTION */
    .cat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
    .cat-btn {
        background: linear-gradient(135deg, rgba(255,255,255,0.05), rgba(255,255,255,0.01));
        border: 1px solid var(--glass-border);
        color: #fff;
        padding: 20px;
        font-family: 'Orbitron';
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: 0.3s;
        text-transform: uppercase;
        font-size: 12px;
    }
    .cat-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px var(--primary-dim); }

    /* GAMEPLAY UI */
    .gameplay-ui { width: 100%; display: none; flex-direction: column; height: 100%; }
    .timer-bar-bg { width: 100%; height: 6px; background: #222; border-radius: 3px; margin-bottom: 20px; overflow: hidden; }
    .timer-bar-fill { width: 100%; height: 100%; background: var(--primary); transition: width 1s linear; box-shadow: 0 0 10px var(--primary); }
    
    .question-box {
        background: rgba(0,0,0,0.3);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 25px;
        border: 1px solid rgba(255,255,255,0.05);
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        width: 100%;
    }
    .q-text { font-size: 16px; font-weight: 500; line-height: 1.5; margin: 0; }
    .q-image { max-width: 100%; max-height: 200px; margin-top: 15px; border-radius: 10px; border: 1px solid var(--primary); }
    
    .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; width: 100%; }
    .opt-btn {
        background: transparent;
        border: 1px solid rgba(255,255,255,0.2);
        color: #ddd;
        padding: 15px;
        border-radius: 10px;
        cursor: pointer;
        transition: 0.2s;
        font-family: 'Poppins';
        font-size: 13px;
        text-align: left;
        display: flex; align-items: center; gap: 10px;
    }
    .opt-btn:hover:not(:disabled) { border-color: var(--primary); background: rgba(41, 243, 255, 0.05); color: #fff; }
    .opt-btn:disabled { cursor: default; }
    
    .opt-correct { background: rgba(46, 204, 113, 0.2) !important; border-color: #2ecc71 !important; color: #2ecc71 !important; }
    .opt-wrong { background: rgba(255, 71, 87, 0.2) !important; border-color: #ff4757 !important; color: #ff4757 !important; }

    .q-counter { position: absolute; top: -40px; right: 0; font-family: 'Orbitron'; color: var(--primary); font-size: 12px; }

    /* STATS SCREEN */
    .stats-screen { display: none; flex-direction: column; align-items: center; width: 100%; animation: fadeIn 0.5s; }
    .stats-pfp { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--gold); margin-bottom: 10px; box-shadow: 0 0 20px rgba(255,215,0,0.3); }
    .stats-name { font-family: 'Orbitron'; font-size: 18px; margin-bottom: 20px; color: #fff; }
    
    .stats-grid { display: flex; gap: 30px; margin-bottom: 30px; width: 100%; justify-content: center; }
    .stat-box { text-align: center; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 12px; min-width: 100px; }
    .stat-val { font-family: 'Orbitron'; font-size: 24px; font-weight: 700; display: block; }
    .stat-lbl { font-size: 10px; color: var(--text-muted); text-transform: uppercase; }
    
    .val-green { color: #2ecc71; }
    .val-red { color: #ff4757; }
    .val-gold { color: #ffd700; }

    .btn-collect {
        background: linear-gradient(90deg, #ffd700, #ffaa00);
        color: #000;
        font-family: 'Orbitron';
        font-weight: 800;
        border: none;
        padding: 15px 40px;
        border-radius: 50px;
        cursor: pointer;
        font-size: 16px;
        box-shadow: 0 0 20px rgba(255, 215, 0, 0.4);
        transition: 0.3s;
        text-transform: uppercase;
        animation: pulseBtn 2s infinite;
    }
    .btn-collect:hover { transform: scale(1.05); box-shadow: 0 0 30px rgba(255, 215, 0, 0.7); }

    @keyframes pulseBtn { 0% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 215, 0, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 215, 0, 0); } }
    @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }

    /* REWARD POPUP (REUSED STYLE) */
    .reward-modal {
        position: fixed; inset: 0; background: rgba(0,0,0,0.9);
        display: none; justify-content: center; align-items: center;
        z-index: 12000; padding: 20px;
    }
    .reward-modal.active { display: flex; }
    .reward-card {
        background: #08101b; border: 2px solid #ffd700; border-radius: 35px;
        padding: 40px 20px; text-align: center; max-width: 420px; width: 100%;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.15);
        animation: jumpIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    @keyframes jumpIn { 0% { transform: scale(0.3) translateY(100px); opacity: 0; } 100% { transform: scale(1) translateY(0); opacity: 1; } }
    .super-btn { background: #00ffff; color: #000; font-family: 'Orbitron'; font-weight: 900; border: none; padding: 15px 50px; border-radius: 50px; cursor: pointer; font-size: 16px; text-transform: uppercase; box-shadow: 0 0 20px rgba(0, 255, 255, 0.6); transition: 0.3s; margin-top: 10px; }
    .super-btn:hover { transform: scale(1.05); }

    /* Bubble/Banner CSS Classes (Copied from Index for Consistency) */
    .bubble-galaxy { background: linear-gradient(135deg, #1a0b2e, #5000ca); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 0 15px rgba(138, 43, 226, 0.6); }
    .bubble-toxic { background: repeating-linear-gradient(45deg, #000, #000 10px, #1b3a08 10px, #1b3a08 20px); border: 2px solid #39ff14; color: #39ff14; }
    .bubble-fire { background: linear-gradient(to bottom, #500000, #a00000); border: 2px solid #ff4500; color: #ffd700; }
    .bubble-midas { background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%), radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%); color: #4a3b0f; border: 1px solid #ffd700; }
    /* ... more can be added if needed, fallback default handles the rest ... */

  </style>
</head>
<body>

<!-- REWARD MODAL -->
<div id="gameRewardModal" class="reward-modal">
    <div class="reward-card">
        <h2><span style="font-size: 24px;">üèÜ</span> FELICITƒÇRI!</h2>
        <p id="rewardMsg">Ai rƒÉspuns corect la X din 15 √ÆntrebƒÉri.</p>
        <div style="font-size: 50px; font-weight: 900; color: #ffd700; margin: 20px 0; display: flex; align-items: center; justify-content: center; gap: 15px; font-family: 'Orbitron';">
            <img src="https://iili.io/fhc1SKQ.png" alt="Coin" style="width: 50px;">
            <span id="rewardAmount">0</span>
        </div>
        <p style="color: #ffd700; font-weight: 800; font-family: 'Orbitron'; font-size: 12px; letter-spacing: 2px;">KSDA COINS</p>
        <button class="super-btn" onclick="window.location.reload()">NOU JOC</button>
    </div>
</div>

<!-- Header -->
<div class="header-container">
    <header>
        <a href="index.html" class="logo">
            <img src="https://iili.io/fXvBEiB.png" alt="KSDA Logo">
        </a>
        <nav>
            <a href="index.html">AcasƒÉ</a>
            <a href="joc.html" style="color:var(--primary);">Trivia</a>
            <button id="headerLoginBtn" class="login-btn-header">LOGIN</button>
        </nav>
    </header>
</div>

<!-- Main Game Section -->
<section class="game-section">
    <h1 class="metallic-title-big">TRIVIA KSDA</h1>
    <p class="game-desc">DemonstreazƒÉ-»õi cuno»ôtin»õele, rƒÉspunde la √ÆntrebƒÉri »ôi c√¢»ôtigƒÉ monede KSDA! Fiecare rƒÉspuns corect valoreazƒÉ aur.</p>

    <div class="game-container" id="mainGameBox">
        
        <!-- HEADER (Inside Box) -->
        <div class="game-header" id="gameHeader">
            <img src="https://i.pinimg.com/736x/c0/27/ce/c027ce75f560e20300a202d68e59074d.jpg" class="gh-pfp" id="ghPfp">
            <div class="gh-info">
                <div class="gh-name" id="ghName">Vizitator</div>
                <div class="gh-badge" id="ghBadge">Membru</div>
            </div>
        </div>

        <!-- CONTENT AREA -->
        <div class="game-content">
            
            <!-- STATE 1: LOCKED (Not Logged In) -->
            <div id="viewLocked" class="locked-view">
                <i class="fas fa-lock lock-icon"></i>
                <h3 class="lock-title">Acces Membri</h3>
                <p class="lock-text">Pentru a vedea √ÆntrebƒÉrile »ôi a participa la joc, trebuie sƒÉ te autentifici.</p>
                <button class="login-btn-header" onclick="document.getElementById('headerLoginBtn').click()">LOGHEAZƒÇ-TE CU GOOGLE</button>
            </div>

            <!-- STATE 2: MODE SELECT (Logged In) -->
            <div id="viewMode" class="locked-view" style="display: none;">
                <h3 style="margin-bottom: 20px; font-family:'Orbitron';">ALEGE MODUL</h3>
                <div class="mode-select-grid">
                    <div class="mode-card" onclick="startGameFlow('single')">
                        <i class="fas fa-user mode-icon"></i>
                        <div class="mode-title">SINGLEPLAYER</div>
                        <div style="font-size:10px; color:#aaa; margin-top:5px;">JoacƒÉ singur, c√¢»ôtigƒÉ monede.</div>
                    </div>
                    <div class="mode-card mode-locked">
                        <i class="fas fa-users mode-icon" style="color:#555;"></i>
                        <div class="mode-title" style="color:#777;">MULTIPLAYER</div>
                        <div style="font-size:10px; color:#555; margin-top:5px;">√én cur√¢nd...</div>
                    </div>
                </div>
            </div>

            <!-- STATE 3: CATEGORY SELECT -->
            <div id="viewCategory" class="locked-view" style="display: none;">
                <h3 style="margin-bottom: 20px; font-family:'Orbitron';">ALEGE CATEGORIA</h3>
                <div class="cat-grid">
                    <button class="cat-btn" onclick="startQuiz('science')">»òTIIN»öƒÇ</button>
                    <button class="cat-btn" onclick="startQuiz('general')">CULTURƒÇ GENERALƒÇ</button>
                    <button class="cat-btn" onclick="startQuiz('ksda')">KSDA TRIVIA</button>
                    <button class="cat-btn" onclick="startQuiz('geo')">GEOGRAFIE</button>
                </div>
            </div>

            <!-- STATE 4: GAMEPLAY -->
            <div id="viewGame" class="gameplay-ui">
                <div class="q-counter">√éntrebarea <span id="qCurrent">1</span>/15</div>
                
                <div class="timer-bar-bg">
                    <div id="timerBar" class="timer-bar-fill"></div>
                </div>

                <div class="question-box">
                    <p id="qText" class="q-text">Se √ÆncarcƒÉ √Æntrebarea...</p>
                    <div id="qImageContainer"></div> <!-- Image for KSDA category goes here -->
                </div>

                <div class="options-grid" id="optionsContainer">
                    <!-- Options injected via JS -->
                </div>
            </div>

            <!-- STATE 5: STATS & REWARD -->
            <div id="viewStats" class="stats-screen">
                <img id="statsPfp" src="" class="stats-pfp">
                <div id="statsName" class="stats-name">User</div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <span id="statCorrect" class="stat-val val-green">0</span>
                        <span class="stat-lbl">Corecte</span>
                    </div>
                    <div class="stat-box">
                        <span id="statWrong" class="stat-val val-red">0</span>
                        <span class="stat-lbl">Gre»ôite</span>
                    </div>
                    <div class="stat-box">
                        <span id="statCoins" class="stat-val val-gold">0</span>
                        <span class="stat-lbl">Coins</span>
                    </div>
                </div>

                <button class="btn-collect" id="collectRewardBtn">
                    <i class="fas fa-gift"></i> COLLECT MY REWARD
                </button>
            </div>

        </div>
    </div>
</section>

<!-- Footer -->
<footer style="text-align:center; padding: 20px; color: #555; font-size: 12px; margin-top: auto;">
    &copy; 2024 KSDAPromovari. Toate drepturile rezervate.
</footer>

<!-- FIREBASE & LOGIC -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    // --- CONFIG (Same as index) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDoH80kffNrzFAcyRqsTVdifs-whUhwH9A",
      authDomain: "ksda-7546f.firebaseapp.com",
      projectId: "ksda-7546f",
      storageBucket: "ksda-7546f.firebasestorage.app",
      messagingSenderId: "306437513808",
      appId: "1:306437513808:web:28479810e3fdf71b32e755"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // DOM Elements
    const views = {
        locked: document.getElementById('viewLocked'),
        mode: document.getElementById('viewMode'),
        category: document.getElementById('viewCategory'),
        game: document.getElementById('viewGame'),
        stats: document.getElementById('viewStats')
    };

    const headerLoginBtn = document.getElementById('headerLoginBtn');
    const ghPfp = document.getElementById('ghPfp');
    const ghName = document.getElementById('ghName');
    const ghBadge = document.getElementById('ghBadge');
    const gameHeader = document.getElementById('gameHeader');
    const rewardModal = document.getElementById('gameRewardModal');

    // Game Variables
    let currentUser = null;
    let questions = [];
    let currentQIndex = 0;
    let score = 0; // Correct answers
    let timerInterval = null;
    let timeLeft = 10;
    let isAnswering = false;

    // --- AUTH LOGIC ---
    headerLoginBtn.onclick = async () => {
        try {
            await signInWithPopup(auth, provider);
        } catch(e) { console.error(e); }
    };

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            headerLoginBtn.innerText = "CONTUL MEU";
            
            // Fetch User Data for Header customization
            const snap = await getDoc(doc(db, "accounts", user.uid));
            if(snap.exists()) {
                const data = snap.data();
                ghPfp.src = data.image || user.photoURL;
                ghName.innerText = data.username || user.displayName;
                
                // Set Equipped Banner style
                if(data.equippedBanner && data.equippedBanner.cssClass) {
                    gameHeader.className = `game-header ${data.equippedBanner.cssClass}`;
                } else {
                    gameHeader.className = `game-header`; // reset
                }

                // Set Badge text
                if(data.equippedBadge) ghBadge.innerText = data.equippedBadge.text;
            }

            switchView('mode');
        } else {
            currentUser = null;
            headerLoginBtn.innerText = "LOGIN";
            ghPfp.src = "https://i.pinimg.com/736x/c0/27/ce/c027ce75f560e20300a202d68e59074d.jpg";
            ghName.innerText = "Vizitator";
            ghBadge.innerText = "Guest";
            gameHeader.className = 'game-header';
            switchView('locked');
        }
    });

    // --- NAVIGATION LOGIC ---
    function switchView(viewName) {
        Object.values(views).forEach(el => el.style.display = 'none');
        views[viewName].style.display = (viewName === 'game') ? 'flex' : 'flex'; 
        // Note: 'game' needs flex-direction column, handled in CSS
        if(viewName === 'locked' || viewName === 'mode' || viewName === 'category') {
             views[viewName].style.flexDirection = 'column'; // Ensure centering
        }
    }

    window.startGameFlow = (mode) => {
        if(mode === 'single') switchView('category');
    };

    window.startQuiz = (category) => {
        generateQuestions(category);
        currentQIndex = 0;
        score = 0;
        switchView('game');
        loadQuestion();
    };

    // --- GAME DATA (MOCK QUESTIONS) ---
    function generateQuestions(cat) {
        // In a real app, fetch from DB. Here we hardcode for demo.
        const pool = [];
        
        if (cat === 'ksda') {
            // KSDA Specific Questions
            for(let i=1; i<=15; i++) {
                pool.push({
                    q: `√éntrebare KSDA #${i}: Cine este creatorul acestui website?`,
                    opts: ["Lost Soul", "Kevin Trinity", "Narcisa", "Un Robot"],
                    correct: 0,
                    img: i === 1 ? true : false // Show image on first question only for demo (or all if needed)
                });
            }
            // Overwrite specific logic for question 1 to show the image requested
             pool[0] = {
                q: "Ce reprezintƒÉ imaginea de mai jos √Æn universul KSDA?",
                opts: ["Un logo vechi", "O pozƒÉ random", "Un teaser viitor", "Portret Kevin"],
                correct: 1,
                img: true
             };

        } else if (cat === 'science') {
            for(let i=1; i<=15; i++) pool.push({ q: `Care este simbolul chimic pentru Aur? (Q${i})`, opts: ["Au", "Ag", "Fe", "Cu"], correct: 0 });
        } else if (cat === 'geo') {
            for(let i=1; i<=15; i++) pool.push({ q: `Care este capitala Fran»õei? (Q${i})`, opts: ["Londra", "Berlin", "Paris", "Roma"], correct: 2 });
        } else {
            for(let i=1; i<=15; i++) pool.push({ q: `√én ce an a √Ænceput WW2? (Q${i})`, opts: ["1914", "1939", "1945", "1960"], correct: 1 });
        }
        questions = pool;
    }

    // --- GAME LOOP ---
    function loadQuestion() {
        if (currentQIndex >= 15) {
            endGame();
            return;
        }

        isAnswering = false;
        const qData = questions[currentQIndex];
        
        // UI Updates
        document.getElementById('qCurrent').innerText = currentQIndex + 1;
        document.getElementById('qText').innerText = qData.q;
        
        // Image Handling (KSDA Category)
        const imgContainer = document.getElementById('qImageContainer');
        imgContainer.innerHTML = '';
        if (qData.img) {
            // The specific image requested
            imgContainer.innerHTML = `<a href="https://ibb.co/DHMcmWYm" target="_blank"><img src="https://i.ibb.co/7dpMBCQB/92d1760603edb303d32a69aa6180d6a6-tplv-tiktokx-cropcenter-1080-1080.jpg" class="q-image" alt="KSDA Image"></a>`;
        }

        // Options
        const optsContainer = document.getElementById('optionsContainer');
        optsContainer.innerHTML = '';
        qData.opts.forEach((optText, idx) => {
            const btn = document.createElement('button');
            btn.className = 'opt-btn';
            btn.innerHTML = `<span style="font-weight:700; color:var(--primary);">${String.fromCharCode(65+idx)}.</span> ${optText}`;
            btn.onclick = () => handleAnswer(idx);
            optsContainer.appendChild(btn);
        });

        // Timer Reset
        clearInterval(timerInterval);
        timeLeft = 10;
        updateTimerBar();
        timerInterval = setInterval(() => {
            timeLeft--;
            updateTimerBar();
            if(timeLeft <= 0) {
                handleAnswer(-1); // Time out = wrong
            }
        }, 1000);
    }

    function updateTimerBar() {
        const bar = document.getElementById('timerBar');
        const pct = (timeLeft / 10) * 100;
        bar.style.width = `${pct}%`;
        if (timeLeft < 3) bar.style.background = '#ff4757';
        else bar.style.background = '#29f3ff';
    }

    function handleAnswer(selectedIndex) {
        if(isAnswering) return;
        isAnswering = true;
        clearInterval(timerInterval);

        const qData = questions[currentQIndex];
        const buttons = document.querySelectorAll('.opt-btn');

        // Visual Feedback
        if(selectedIndex === qData.correct) {
            score++;
            if(buttons[selectedIndex]) buttons[selectedIndex].classList.add('opt-correct');
        } else {
            if(buttons[selectedIndex]) buttons[selectedIndex].classList.add('opt-wrong');
            // Show correct one
            buttons[qData.correct].classList.add('opt-correct');
        }

        // Disable all
        buttons.forEach(b => b.disabled = true);

        // Wait then Next
        setTimeout(() => {
            currentQIndex++;
            loadQuestion();
        }, 1500);
    }

    // --- END GAME & REWARDS ---
    function endGame() {
        switchView('stats');
        
        // Update Stats UI
        document.getElementById('statsPfp').src = ghPfp.src;
        document.getElementById('statsName').innerText = ghName.innerText;
        document.getElementById('statCorrect').innerText = score;
        document.getElementById('statWrong').innerText = 15 - score;
        
        const totalCoins = score * 25;
        document.getElementById('statCoins').innerText = totalCoins;

        // Setup Collect Button
        const btn = document.getElementById('collectRewardBtn');
        btn.onclick = async () => {
            if(!currentUser) return;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Se proceseazƒÉ...';
            btn.disabled = true;

            try {
                // Update Firebase
                const userRef = doc(db, "accounts", currentUser.uid);
                await updateDoc(userRef, {
                    coins: increment(totalCoins)
                });

                // Show Reward Modal
                document.getElementById('rewardMsg').innerText = `Ai rƒÉspuns corect la ${score} din 15 √ÆntrebƒÉri.`;
                document.getElementById('rewardAmount').innerText = totalCoins;
                rewardModal.classList.add('active');
            } catch(e) {
                alert("Eroare la salvare: " + e.message);
                btn.disabled = false;
                btn.innerText = "RE√éNCEARCƒÇ";
            }
        };
    }

</script>
</body>
</html>
