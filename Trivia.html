<!DOCTYPE html>
<html lang="ro">
<head>
  <!-- Google tag (gtag.js) -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-B6DWPJ4T2C"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-B6DWPJ4T2C');
  </script>

  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KSDA Trivia — Multiplayer</title>
  <link rel="icon" type="image/png" href="https://iili.io/fXks1Dv.png">  
  <!-- Fonts & Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;600;700;800;900&family=Poppins:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    /* --- THEME VARIABLES --- */
    :root {
      --bg-dark: #050b14;
      --primary: #29f3ff;
      --glass-bg: rgba(13, 25, 41, 0.95);
      --glass-border: rgba(255, 255, 255, 0.08);
      --text-main: #ffffff;
      --text-muted: #a5b1c2;
    }

    * { box-sizing: border-box; outline: none; }
    html { scroll-behavior: smooth; }

    body {
      margin: 0; min-height: 100vh;
      background-color: var(--bg-dark);
      background-image: linear-gradient(to bottom, rgba(5, 11, 20, 0.85), var(--bg-dark)), url('https://i.makeagif.com/media/3-03-2021/otrneG.gif');
      background-position: center; background-size: cover; background-attachment: fixed;
      font-family: 'Poppins', sans-serif; color: var(--text-main);
      display: flex; flex-direction: column; overflow-x: hidden;
    }

    /* SCROLLBAR */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-dark); }
    ::-webkit-scrollbar-thumb { background: #1f3a52; border-radius: 4px; }
    
    /* FONTS */
    h1, h2, h3, .logo, .btn, .metallic-title, .trivia-stat-val, .cat-btn, .answer-option, .lobby-status, .pop-user, .round-player-name { font-family: 'Orbitron', sans-serif; }

    /* --- ACCOUNT MODAL --- */
    .account-modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 11000; backdrop-filter: blur(10px); }
    .account-modal-overlay.active { display: flex; }
    .account-card { background: #08101b; border: 1px solid var(--primary); width: 90%; max-width: 380px; border-radius: 30px; padding: 40px 25px; text-align: center; position: relative; animation: jumpIn 0.5s forwards; }
    .close-pop { position: absolute; top: 15px; right: 20px; color: #fff; cursor: pointer; font-size: 24px; background: none; border: none; }
    .profile-frame-wrapper { position: relative; width: 90px; height: 90px; margin: 0 auto 12px auto; display: flex; justify-content: center; align-items: center; }
    .pop-img-inner { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; z-index: 1; border: 2px solid rgba(255,255,255,0.1); }
    .pop-frame-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 145%; height: 145%; z-index: 2; pointer-events: none; }
    .btn-row-pop { display: flex; gap: 10px; justify-content: center; margin-top: 15px; }
    .btn-cosmetics { background: transparent; border: 1.5px solid #d63384; color: #d63384; padding: 8px 15px; border-radius: 50px; cursor: pointer; font-family: 'Orbitron'; font-size: 10px; font-weight: 700; }
    .btn-logout-pop { background: transparent; border: 1.5px solid #ff4757; color: #ff4757; padding: 10px 25px; border-radius: 12px; font-family: 'Orbitron'; font-weight: 700; cursor: pointer; margin-top: 20px; }

    /* --- INVENTORY MODAL --- */
    .shop-modal-card { background: #08101b; border: 1px solid #d63384; width: 95%; max-width: 600px; border-radius: 30px; padding: 30px; text-align: center; position: relative; max-height: 85vh; overflow-y: auto; display:flex; flex-direction:column; }
    .badges-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; padding: 10px; }
    .shop-badge-item { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 10px; text-align: center; }
    .equip-btn { background: #2ecc71; color: #000; border: none; padding: 4px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; cursor: pointer; margin-top: 5px; width: 100%; }

    /* --- HEADER --- */
    .header-container { position: fixed; top: 0; left: 0; right: 0; padding: 20px; z-index: 1000; display: flex; justify-content: center; }
    header { width: 100%; max-width: 1200px; display: flex; align-items: center; justify-content: space-between; padding: 12px 30px; background: rgba(5, 11, 20, 0.8); border: 1px solid var(--glass-border); border-radius: 100px; backdrop-filter: blur(16px); }
    .logo { font-weight: 900; font-size: 24px; letter-spacing: 1px; background: linear-gradient(90deg, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-decoration: none; }
    nav { display: flex; gap: 32px; align-items: center; }
    nav a { color: var(--text-muted); text-decoration: none; font-size: 13px; font-weight: 600; transition: 0.3s; }
    nav a:hover { color: var(--primary); }
    .login-btn-header { background: transparent; border: 1.5px solid var(--primary); color: var(--primary); padding: 8px 20px; border-radius: 20px; font-size: 12px; font-weight: 700; cursor: pointer; text-transform: uppercase; transition: 0.3s; display: flex; align-items: center; gap: 8px; }
    .login-btn-header:hover { background: var(--primary); color: #000; box-shadow: 0 0 15px rgba(41, 243, 255, 0.4); }
    .user-avatar-small { width: 24px; height: 24px; border-radius: 50%; border: 1px solid #fff; display: none; object-fit: cover; }
    .hamburger { display: none; background: none; border: none; color: #fff; font-size: 26px; cursor: pointer; }

    /* --- SIDE MENU --- */
    #sideMenu { position: fixed; inset: 0; left: auto; width: 320px; background: #080f1a; border-left: 1px solid rgba(255,255,255,0.05); z-index: 2000; padding: 40px 30px; transform: translateX(100%); transition: transform 0.4s cubic-bezier(0.77, 0, 0.175, 1); display: flex; flex-direction: column; }
    #sideMenu.open { transform: translateX(0); }
    .menu-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
    .closeBtn { font-size: 40px; background: none; border: none; color: #fff; cursor: pointer; }
    .menu-links a { display: block; color: #fff; text-decoration: none; font-size: 26px; font-weight: 600; margin-bottom: 20px; font-family: 'Orbitron'; }
    .side-menu-login-btn { background: rgba(41, 243, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); width: 100%; padding: 15px; margin-top: 20px; border-radius: 12px; font-size: 16px; font-weight: 700; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 10px; }

    /* --- TRIVIA LAYOUT --- */
    .metallic-title { 
        font-size: clamp(32px, 5vw, 56px); 
        background: linear-gradient(180deg, #ffffff 0%, #a2cfff 100%); 
        -webkit-background-clip: text; -webkit-text-fill-color: transparent; 
        text-shadow: 0 10px 30px rgba(0,0,0,0.5); 
        text-align: center; margin-bottom: 10px; text-transform: uppercase; font-weight: 800; margin-top: 140px;
    }
    .trivia-desc { text-align: center; color: var(--text-muted); margin-bottom: 40px; max-width: 600px; margin-left: auto; margin-right: auto; }

    .game-card {
        width: 100%; max-width: 900px; margin: 0 auto 80px; 
        background: var(--glass-bg); border: 1px solid var(--primary); 
        border-radius: 24px; display: flex; flex-direction: column; 
        overflow: hidden; box-shadow: 0 0 40px rgba(41, 243, 255, 0.15); 
        min-height: 650px; position: relative;
    }

    /* GAME HEADER */
    .game-header { padding: 15px 20px; background: rgba(0,0,0,0.4); border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
    .game-header.banner-active { border-radius: 24px 24px 0 0; border-bottom: 1px solid rgba(255,255,255,0.2); }
    .user-profile { display: flex; align-items: center; gap: 10px; }
    .header-frame-wrapper { position: relative; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; }
    .user-pfp-inner { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; z-index: 1; border: 1px solid var(--primary); }
    .header-frame-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 145%; height: 145%; z-index: 2; pointer-events: none; }
    
    /* VIEWS */
    .view-section { display: none; flex: 1; flex-direction: column; padding: 20px; text-align: center; justify-content: center; height: 100%; animation: fadeIn 0.5s; }
    .view-section.active { display: flex; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

    /* MENU BUTTONS */
    .mode-btn {
        background: rgba(41, 243, 255, 0.05); border: 2px solid var(--primary); color: #fff;
        padding: 30px; margin: 15px; border-radius: 20px; font-size: 22px; cursor: pointer;
        transition: 0.3s; width: 100%; max-width: 350px; display: inline-block;
        font-family: 'Orbitron'; font-weight: 800; text-transform: uppercase;
    }
    .mode-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 30px rgba(41, 243, 255, 0.15); transform: scale(1.05); }

    /* LOBBY (10 Players) */
    .lobby-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(90px, 1fr)); gap: 15px; max-width: 600px; margin: 20px auto; }
    .lobby-slot { 
        height: 120px; background: rgba(255,255,255,0.03); border-radius: 12px; border: 1px dashed #444; 
        display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
    }
    .lobby-slot.filled { border: 2px solid var(--primary); background: rgba(41, 243, 255, 0.05); border-style: solid; }
    
    .lobby-avatar-wrapper { position: relative; width: 50px; height: 50px; margin-bottom: 8px; display:flex; justify-content:center; align-items:center;}
    .lobby-avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; z-index: 1; }
    .lobby-frame { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 150%; height: 150%; z-index: 2; pointer-events: none; }
    .lobby-name { font-size: 10px; font-weight: 700; max-width: 85px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }

    /* VOTING */
    .voting-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
    .cat-btn {
        background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
        padding: 20px; border-radius: 15px; color: #fff; cursor: pointer; transition: 0.3s;
        display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative;
    }
    .cat-btn:hover { border-color: var(--primary); background: rgba(41, 243, 255, 0.05); }
    .cat-btn.selected { background: var(--primary); color: #000; box-shadow: 0 0 20px rgba(41, 243, 255, 0.15); }
    .vote-count { position: absolute; top: 10px; right: 10px; background: #000; color: #fff; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
    .cat-btn.winner { border: 4px solid #ffd700; box-shadow: 0 0 30px #ffd700; transform: scale(1.05); z-index: 10; }

    /* GAMEPLAY */
    .timer-bar-bg { width: 100%; height: 8px; background: #333; border-radius: 10px; overflow: hidden; margin-bottom: 20px; }
    .timer-bar-fill { height: 100%; background: var(--primary); width: 100%; transition: width 1s linear; }
    .question-box { font-size: 22px; font-weight: 600; margin-bottom: 30px; min-height: 80px; display: flex; align-items: center; justify-content: center; text-align: center; }
    .answers-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    .answer-option {
        background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
        padding: 20px; border-radius: 15px; color: #fff; font-size: 16px; 
        cursor: pointer; transition: 0.2s; text-align: left; display: flex; align-items: center; gap: 10px;
    }
    .answer-option:hover { background: rgba(255,255,255,0.15); transform: translateY(-2px); }
    .answer-option.selected { border-color: var(--primary); background: rgba(41, 243, 255, 0.1); }
    .answer-option.correct { background: #2ecc71 !important; color: #000; border-color: #2ecc71; }
    .answer-option.wrong { background: #ff4757 !important; color: #fff; border-color: #ff4757; opacity: 0.5; }

    /* ROUND RESULTS (New Feature) */
    .round-results-overlay { 
        position: absolute; top:0; left:0; width:100%; height:100%; 
        background: rgba(0,0,0,0.9); z-index: 50; display:none; flex-direction: column; align-items: center; justify-content: center;
        backdrop-filter: blur(5px);
    }
    .round-results-list { width: 90%; max-width: 500px; max-height: 400px; overflow-y: auto; background: #111; border: 1px solid #333; border-radius: 15px; padding: 20px; }
    .round-player-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
    .round-player-name { font-size: 14px; font-weight: bold; color: #fff; display: flex; align-items: center; gap: 10px; }
    .round-player-status { font-weight: bold; }
    .status-correct { color: #2ecc71; }
    .status-wrong { color: #ff4757; }
    .status-time { font-size: 12px; color: #aaa; margin-left: 10px; }

    /* FINAL LEADERBOARD */
    .leaderboard-list { text-align: left; max-width: 400px; margin: 0 auto; }
    .lb-item { background: rgba(255,255,255,0.1); padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; }
    .lb-rank { font-size: 20px; font-weight: 900; width: 30px; }
    .lb-score { font-weight: 700; color: #ffd700; }

    @keyframes jumpIn { 0% { transform: scale(0.3); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

    /* --- BANNERS CSS FROM WALL.HTML --- */
    .bubble-galaxy { background: linear-gradient(135deg, #1a0b2e, #5000ca); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 0 15px rgba(138, 43, 226, 0.6); }
    .bubble-toxic { background: repeating-linear-gradient(45deg, #000, #000 10px, #1b3a08 10px, #1b3a08 20px); border: 2px solid #39ff14; color: #39ff14; }
    .bubble-fire { background: linear-gradient(to bottom, #500000, #a00000); border: 2px solid #ff4500; }
    .bubble-midas { background: radial-gradient(ellipse farthest-corner at right bottom, #FEDB37 0%, #FDB931 8%, #9f7928 30%, #8A6E2F 40%, transparent 80%), radial-gradient(ellipse farthest-corner at left top, #FFFFFF 0%, #FFFFAC 8%, #D1B464 25%, #5d4a1f 62.5%, #5d4a1f 100%); border: 1px solid #ffd700; color:#4a3b0f; }
    .bubble-void { background: #000; color: #fff; border: 1px solid #333; box-shadow: 0 0 15px #000; }
    .bubble-comic { background: #fff; border: 3px solid #000; color: #000; box-shadow: 5px 5px 0px #000; font-weight: 900; }
    .bubble-ice { background: linear-gradient(to bottom, #e3fdfd, #cbf1f5); border: 1px solid #a6e3e9; color: #006994; }
    .bubble-anim-chroma { background: linear-gradient(124deg, #ff2400, #e81d1d, #e8b71d, #e3e81d, #1de840, #1ddde8, #2b1de8, #dd00f3, #dd00f3); background-size: 400% 400%; animation: gradientMove 3s ease infinite; color: #fff; }
    @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }

  </style>
</head>
<body>

  <!-- 1. ACCOUNT MODAL -->
  <div id="accountModal" class="account-modal-overlay">
    <div class="account-card">
        <button id="closeAccountPop" class="close-pop">✕</button>
        <div class="profile-frame-wrapper">
            <img id="popUserImg" src="" class="pop-img-inner">
            <img id="popUserFrame" src="" class="pop-frame-overlay" style="display: none;">
        </div>
        <h3 id="popUserName" class="pop-user">User</h3>
        <p id="popUserEmail" style="font-size:12px; color:#aaa;">email</p>
        <div class="btn-row-pop">
            <button id="openCosmeticsBtn" class="btn-cosmetics"><i class="fas fa-palette"></i> COSMETICS</button>
        </div>
        <button id="popLogoutBtn" class="btn-logout-pop">LOG OUT</button>
    </div>
  </div>

  <!-- 2. COSMETICS SELECT MODAL -->
  <div id="cosmeticsSelectModal" class="account-modal-overlay">
      <div class="account-card" style="max-width:300px;">
          <button class="close-pop" onclick="document.getElementById('cosmeticsSelectModal').classList.remove('active')">✕</button>
          <h3 style="margin-bottom:20px;">ALEGE</h3>
          <button class="mode-btn" style="padding:15px; font-size:14px; margin:5px;" onclick="openInventory('frames')">Rame</button>
          <button class="mode-btn" style="padding:15px; font-size:14px; margin:5px;" onclick="openInventory('banners')">Bannere</button>
      </div>
  </div>

  <!-- 3. INVENTORY MODAL -->
  <div id="inventoryModal" class="account-modal-overlay">
      <div class="shop-modal-card">
          <button class="close-pop" onclick="document.getElementById('inventoryModal').classList.remove('active')">✕</button>
          <h2 style="color:var(--primary);">INVENTAR</h2>
          <div id="inventoryList" class="badges-container"></div>
      </div>
  </div>

  <!-- HEADER -->
  <div class="header-container">
    <header>
      <a href="index.html" class="logo">KSDA</a>      
      <nav>
        <a href="wall.html">Wall</a>
        <a href="trivia.html" style="color: var(--primary);">Trivia</a>
        <button id="headerLoginBtn" class="login-btn-header">
            <img id="headerUserImg" src="" class="user-avatar-small">
            <span id="headerLoginText">LOGIN</span>
        </button>
      </nav>
      <button id="menuBtn" class="hamburger">☰</button>
    </header>
  </div>

  <!-- SIDE MENU -->
  <aside id="sideMenu">
    <div class="menu-header">
        <span class="logo">KSDA</span>
        <button id="closeMenu" class="closeBtn">✕</button>
    </div>
    <div class="menu-links">
      <a href="wall.html">Wall</a>
      <a href="trivia.html" style="color:var(--primary);">Trivia</a>
      <button id="mobileLoginBtn" class="side-menu-login-btn">LOGIN</button>
    </div>
  </aside>

  <!-- CONTENT -->
  <h1 class="metallic-title">KSDA TRIVIA</h1>
  <p class="trivia-desc">Multiplayer Live • Până la 10 Jucători</p>

  <div class="game-card">
      
    <!-- GAME HEADER (Banner applied here) -->
    <div id="gameHeaderBar" class="game-header" style="display:none;">
        <div class="user-profile">
            <div class="header-frame-wrapper">
                <img id="gameUserAvatar" src="" class="user-pfp-inner">
                <img id="gameUserFrame" src="" class="header-frame-overlay" style="display: none;">
            </div>
            <div>
                <span style="font-size:10px; color:var(--primary); display:block;">Jucător</span>
                <div id="gameUserName" style="font-weight:700; color:#fff;"></div>
            </div>
        </div>
        <div>
             <span style="font-size:10px; color:#aaa;">COINS:</span>
             <span id="gameUserCoins" style="font-weight:700; color:#ffd700;">0</span>
        </div>
    </div>

    <!-- VIEWS -->
    <div id="lockedView" class="view-section" style="display:flex;">
        <i class="fas fa-lock" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
        <h2>Autentificare Necesară</h2>
        <button onclick="handleLoginFlow()" class="mode-btn" style="padding:15px; font-size:16px;">LOGIN</button>
    </div>

    <div id="menuView" class="view-section">
        <h2 style="color:var(--primary); margin-bottom:30px;">Alege Modul</h2>
        <div>
            <div class="mode-btn" onclick="startSinglePlayerSetup()">Single Player</div>
            <div class="mode-btn" onclick="findMultiplayerGame()">Multiplayer</div>
        </div>
    </div>

    <!-- LOBBY (10 Slots) -->
    <div id="lobbyView" class="view-section">
        <h3 class="lobby-status">LOBBY <span id="lobbyCount">1/10</span></h3>
        <div class="lobby-grid" id="lobbyGrid"></div>
        <div id="hostControls" style="display:none; margin-top:20px;">
            <p style="color:#aaa; font-size:12px;">Ești Host-ul. Pornește când sunt destui jucători.</p>
            <button class="mode-btn" style="padding:10px 30px; font-size:14px; background:#2ecc71; border-color:#2ecc71;" onclick="startVotingPhase()">START JOC</button>
        </div>
        <p id="waitingText" style="margin-top:20px; animation:pulse 1s infinite;">Așteptăm host-ul...</p>
        <button onclick="leaveGame()" style="background:none; border:1px solid #ff4757; color:#ff4757; padding:10px 20px; border-radius:50px; cursor:pointer; margin-top:30px;">IEȘI DIN LOBBY</button>
    </div>

    <!-- VOTING -->
    <div id="votingView" class="view-section">
        <h3>VOTAȚI CATEGORIA</h3>
        <p id="votingResultText" style="color:#ffd700; display:none;">CÂȘTIGĂTOR:</p>
        <p id="voteTimer" style="font-size:30px; font-weight:900; color:var(--primary);">10</p>
        <div class="voting-grid">
            <div class="cat-btn" id="cat_ksda" onclick="castVote('ksda')">
                <i class="fas fa-crown" style="font-size:30px;"></i> KSDA <span class="vote-count" id="vc_ksda">0</span>
            </div>
            <div class="cat-btn" id="cat_general" onclick="castVote('general')">
                <i class="fas fa-globe" style="font-size:30px;"></i> General <span class="vote-count" id="vc_general">0</span>
            </div>
            <div class="cat-btn" id="cat_history" onclick="castVote('history')">
                <i class="fas fa-landmark" style="font-size:30px;"></i> Istorie <span class="vote-count" id="vc_history">0</span>
            </div>
            <div class="cat-btn" id="cat_science" onclick="castVote('science')">
                <i class="fas fa-flask" style="font-size:30px;"></i> Știință <span class="vote-count" id="vc_science">0</span>
            </div>
        </div>
    </div>

    <!-- GAMEPLAY -->
    <div id="gameView" class="view-section" style="justify-content:flex-start; padding-top:30px; position:relative;">
        <div style="display:flex; justify-content:space-between; color:#aaa; font-size:12px; margin-bottom:10px;">
            <span>Category: <strong id="currentCatDisp" style="color:#fff;"></strong></span>
            <span>Q: <strong id="qIndexDisp">1</strong>/15</span>
        </div>
        <div class="timer-bar-bg"><div id="timerBar" class="timer-bar-fill"></div></div>
        
        <div id="questionText" class="question-box">Loading...</div>
        
        <div class="answers-grid" id="answersGrid"></div>

        <!-- ROUND RESULTS OVERLAY -->
        <div id="roundResultsOverlay" class="round-results-overlay">
            <h2 style="color:#fff; margin-bottom:20px;">REZULTATE RUNDA CURENTĂ</h2>
            <div style="color:#aaa; font-size:14px; margin-bottom:10px;">Întrebarea: <span id="roundQText" style="color:#fff;"></span></div>
            <div id="roundResultsList" class="round-results-list"></div>
            <p style="color:var(--primary); margin-top:20px;">Următoarea întrebare în 5s...</p>
        </div>
    </div>

    <!-- LEADERBOARD -->
    <div id="endView" class="view-section">
        <h2 style="color:#ffd700;">JOC TERMINAT!</h2>
        <div id="finalLeaderboard" class="leaderboard-list"></div>
        <button onclick="location.reload()" class="mode-btn" style="padding:15px; font-size:14px; margin-top:20px;">MENIU PRINCIPAL</button>
    </div>

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc, onSnapshot, collection, addDoc, query, where, getDocs, deleteDoc, serverTimestamp, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDoH80kffNrzFAcyRqsTVdifs-whUhwH9A",
      authDomain: "ksda-7546f.firebaseapp.com",
      projectId: "ksda-7546f",
      storageBucket: "ksda-7546f.firebasestorage.app",
      messagingSenderId: "306437513808",
      appId: "1:306437513808:web:28479810e3fdf71b32e755"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    // --- DATABASES FOR INVENTORY ---
const FRAMES_DB = [
        { id: 'fr_gold', name: 'GOLDEN GUARDIAN', price: 3000, img: 'https://i.ibb.co/5xBTcv2f/c2feac12-d32a-48f7-8514-eee47faf2e7e-removalai-preview.png' },
        { id: 'fr_red', name: 'CRIMSON CORE', price: 2000, scale: 1.15, img: 'https://i.ibb.co/5hmPh8LP/db5713a5-198a-4634-9f18-21026b81b198-removalai-preview.png' },
        { id: 'fr_vintage', name: 'VINTAGE', price: 1200, scale: 1.15, img: 'https://i.ibb.co/0ymk5P5K/060318de-c831-456c-8bd5-48361a2910eb-removalai-preview.png' },
        { id: 'fr_neon_purp', name: 'NEON VIOLET', price: 2500, img: 'https://i.ibb.co/20QskpYb/e4277974-c1b1-4414-b825-4c0c0c6ccb8b-removalai-preview.png' },
        { id: 'fr_dark_aura', name: 'DARK AURA', price: 2800, img: 'https://i.ibb.co/kgSSg8hW/37b47041-b7ef-437a-a264-031171530c1e-removalai-preview.png' },
        { id: 'fr_mystic', name: 'MYSTIC CIRCLE', price: 2200, scale: 1.30, img: 'https://i.ibb.co/DHzYt8nd/71f83e00-005a-461a-824a-db1e29e43e9c-removalai-preview.png' },
        { id: 'fr_fire_ring', name: 'RING OF FIRE', price: 2600, img: 'https://i.ibb.co/H5DZj1s/34d1af1c-6476-4a3e-8efd-0232c94b3278-removalai-preview.png' },
        { id: 'fr_royal_g', name: 'ROYAL GOLD', price: 3500, img: 'https://i.ibb.co/r2GNxXXz/c125fcf5-4433-4436-9fb1-8d5860204293-removalai-preview.png' },
        { id: 'fr_frost', name: 'FROSTBITE', price: 2700, img: 'https://i.ibb.co/398WGGqJ/8aed2529-6551-449d-b7af-6cf96ae067fa-removalai-preview.png' },
        { id: 'fr_nature', name: 'NATURE SPIRIT', price: 2100, scale: 1.30, img: 'https://i.ibb.co/1thwZB8P/b7360758-db43-49c8-a3a6-00b3583f1bf5-removalai-preview.png' },
        { id: 'fr_void', name: 'VOID WALKER', price: 4000, scale: 1.30, img: 'https://i.ibb.co/bj7YrZnW/81555995-ad54-4259-87ba-90abe6f689c0-removalai-preview.png' },
        { id: 'fr_plasma', name: 'PLASMA ARC', price: 2900, img: 'https://i.ibb.co/nMh3fG5Y/d9fe1206-dac5-494a-94bc-da8cc7ab923a-removalai-preview.png' },
        { id: 'fr_sun_god', name: 'SUN GOD', price: 5000, img: 'https://i.ibb.co/ks025DfV/97d743be-cad5-4a3d-ad58-33cb1ed6e200-removalai-preview.png' },
        { id: 'fr_toxic', name: 'TOXIC WASTE', price: 2300, scale: 1.35, img: 'https://i.ibb.co/nMYYr8ZB/ec739473-cde1-4ced-b48c-b118141735e9-removalai-preview.png' },
        { id: 'fr_angel', name: 'HOLY HALO', price: 3333, scale: 1.35, img: 'https://i.ibb.co/sxY83fg/905457b0-80b0-4304-bed4-2d88781faf29-removalai-preview.png' },
        { id: 'fr_demon', name: 'DEMON HORNS', price: 6666, scale: 1.35, img: 'https://i.ibb.co/mrgzLPff/136567cc-46ed-4849-ad44-01d07290dbfd-removalai-preview.png' },
        { id: 'fr_love', name: 'LOVE HEARTS', price: 1500, img: 'https://i.ibb.co/KPXxCnC/2076f0c9-aac4-431c-b708-d99ad87b4bf3-removalai-preview.png' },
        { id: 'fr_diamond', name: 'DIAMOND', price: 4500, img: 'https://i.ibb.co/ks6v3qHr/169811e4-7ab8-44dd-bb0e-83009093dcd9-removalai-preview.png' },
        { id: 'fr_mech', name: 'MECHA', price: 2400, img: 'https://i.ibb.co/Vpx0fnbP/3decd472-3a37-4d3c-95fa-f9fefab8ee78-removalai-preview.png' },
        { id: 'fr_glitch', name: 'GLITCH ERROR', price: 3100, img: 'https://i.ibb.co/fzWVhtv2/2bffa166-2107-4bef-b744-3cc7c8e04593-removalai-preview.png' },
        { id: 'fr_galaxy', name: 'GALAXY', price: 3800, img: 'https://i.ibb.co/qL909PLy/2640f988-a425-4589-ba5a-1f780d24916a-removalai-preview.png' }
   ];

const BANNERS_DB = [
    // --- BASIC / STATIC ---
    { id: 'bub_galaxy', name: 'GALAXY', cssClass: 'bubble-galaxy', price: 2500, desc: 'Spațial' },
    { id: 'bub_toxic', name: 'TOXIC', cssClass: 'bubble-toxic', price: 2000, desc: 'Radioactiv' },
    { id: 'bub_fire', name: 'INFERNO', cssClass: 'bubble-fire', price: 2000, desc: 'Clasici' },
    { id: 'bub_midas', name: 'MIDAS', cssClass: 'bubble-midas', price: 5000, desc: 'Solid Gold' },
    { id: 'bub_void', name: 'VOID', cssClass: 'bubble-void', price: 1500, desc: 'Pitch Black' },
    { id: 'bub_comic', name: 'CARTOON', cssClass: 'bubble-comic', price: 2000, desc: 'Bandă Desenată' },
    { id: 'bub_hearts', name: 'LOVE', cssClass: 'bubble-hearts', price: 1500, desc: 'Hearts Static' },
    { id: 'bub_pixel', name: '8-BIT', cssClass: 'bubble-pixel', price: 2500, desc: 'Retro Game' },
    { id: 'bub_graffiti', name: 'GRAFFITI', cssClass: 'bubble-graffiti', price: 3000, desc: 'Street Art' },
    { id: 'bub_ice', name: 'FROZEN', cssClass: 'bubble-ice', price: 2000, desc: 'Înghețat' },
    { id: 'bub_ocean', name: 'OCEAN', cssClass: 'bubble-ocean', price: 2000, desc: 'Deep Blue' },
    { id: 'bub_nature', name: 'FOREST', cssClass: 'bubble-nature', price: 1500, desc: 'Eco Friendly' },
    { id: 'bub_candy', name: 'CANDY', cssClass: 'bubble-candy', price: 1500, desc: 'Dulce' },
    { id: 'bub_military', name: 'ARMY', cssClass: 'bubble-military', price: 2000, desc: 'Camo' },
    { id: 'bub_blueprint', name: 'TECH', cssClass: 'bubble-blueprint', price: 2500, desc: 'Schită' },

    // --- ANIMATED (SICK EFFECTS) ---
    { id: 'anim_chroma', name: 'HYPER RGB', cssClass: 'bubble-anim-chroma', price: 8000, desc: 'Moving Rainbow' },
    { id: 'anim_holo', name: 'HOLOGRAPHIC', cssClass: 'bubble-anim-holo', price: 7500, desc: 'Shiny Metal' },
    { id: 'anim_blood', name: 'BLOOD PULSE', cssClass: 'bubble-anim-blood', price: 6666, desc: 'Pulsing Red' },
    { id: 'anim_glitch', name: 'SYS_ERROR', cssClass: 'bubble-anim-glitch', price: 7000, desc: 'Shaking Text' },
    { id: 'anim_storm', name: 'LIGHTNING', cssClass: 'bubble-anim-storm', price: 6000, desc: 'Flashing Storm' },
    { id: 'anim_neon', name: 'NEON PULSE', cssClass: 'bubble-anim-neon', price: 5500, desc: 'Glowing Pink' },
    { id: 'anim_slime', name: 'TOXIC DRIP', cssClass: 'bubble-anim-slime', price: 5000, desc: 'Moving Slime' },
    { id: 'anim_disco', name: 'DISCO', cssClass: 'bubble-anim-disco', price: 6500, desc: 'Epilepsy Warning' },
    { id: 'anim_gold', name: 'GOLD RUSH', cssClass: 'bubble-anim-gold', price: 10000, desc: 'Shimmering Gold' },
    { id: 'anim_ghost', name: 'POLTERGEIST', cssClass: 'bubble-anim-ghost', price: 4500, desc: 'Floating Fade' },
    { id: 'anim_love', name: 'HEARTBEAT', cssClass: 'bubble-anim-love', price: 4000, desc: 'Pulsing Hearts' },
    { id: 'anim_sparkle', name: 'STARDUST', cssClass: 'bubble-anim-sparkle', price: 5000, desc: 'Twinkling' }
];

    const QUESTIONS = {
        'ksda': [
            { q: "Cine este Ownerul KSDA?", a: ["Lost Soul", "Kevin", "Mary", "Anonim"], c: 0 },
            { q: "În ce an a fost fondat KSDA?", a: ["2020", "2022", "2023", "2024"], c: 3 },
            { q: "Care este culoarea principală?", a: ["Roșu", "Cyan", "Verde", "Galben"], c: 1 },
            { q: "Ce rol are Mary?", a: ["Owner", "Mod", "Helper", "Admin"], c: 1 },
            { q: "Cât costă un badge VIP?", a: ["1000", "2000", "3000", "5000"], c: 1 },
            { q: "Moneda comunității?", a: ["Bitcoin", "KSDA Coins", "V-Bucks", "Lei"], c: 1 },
            { q: "Ce rol are Kevin?", a: ["Bot", "Admin", "Membru", "Nu există"], c: 1 },
            { q: "Cine a creat site-ul?", a: ["Lost Soul", "Freelancer", "AI", "Google"], c: 0 },
            { q: "Ce primești la streak?", a: ["Bani", "Respect/Coins", "Nimic", "Ban"], c: 1 },
            { q: "Poți pune poze pe chat?", a: ["Staff Only", "Oricine", "Nimeni", "VIP"], c: 0 },
            { q: "Ce este 'Wall'?", a: ["Perete", "Chat", "Joc", "Magazin"], c: 1 },
            { q: "Câte categorii trivia sunt?", a: ["2", "3", "4", "5"], c: 2 },
            { q: "Preț Frame Gold?", a: ["1000", "2000", "3000", "5000"], c: 2 },
            { q: "Cine e 'Helper'?", a: ["Kevin", "Norby", "Lost Soul", "Nimeni"], c: 1 },
            { q: "Ce banner costă 10k?", a: ["Galaxy", "Gold Rush", "Toxic", "Void"], c: 1 }
        ],
        'general': [
            { q: "Capitala Franței?", a: ["Berlin", "Madrid", "Paris", "Roma"], c: 2 },
            { q: "Câte continente sunt?", a: ["5", "6", "7", "8"], c: 2 },
            { q: "Cea mai mare planetă?", a: ["Marte", "Pământ", "Jupiter", "Saturn"], c: 2 },
            { q: "Cine a pictat Mona Lisa?", a: ["Picasso", "Da Vinci", "Van Gogh", "Dali"], c: 1 },
            { q: "Formula apei?", a: ["CO2", "H2O", "O2", "NaCl"], c: 1 },
            { q: "Cel mai rapid animal?", a: ["Leu", "Ghepard", "Cal", "Vultur"], c: 1 },
            { q: "Zile an bisect?", a: ["364", "365", "366", "367"], c: 2 },
            { q: "Unde sunt piramidele?", a: ["Mexic", "Egipt", "Peru", "China"], c: 1 },
            { q: "Limbă Brazilia?", a: ["Spaniolă", "Portugheză", "Italiană", "Engleză"], c: 1 },
            { q: "Autor Luceafărul?", a: ["Creangă", "Eminescu", "Caragiale", "Bacovia"], c: 1 },
            { q: "Moneda Japoniei?", a: ["Yen", "Won", "Dolar", "Euro"], c: 0 },
            { q: "Laturi hexagon?", a: ["5", "6", "7", "8"], c: 1 },
            { q: "Culoare clorofilă?", a: ["Roșu", "Galben", "Verde", "Albastru"], c: 2 },
            { q: "Cel mai lung fluviu?", a: ["Nil", "Amazon", "Dunărea", "Mississippi"], c: 0 },
            { q: "Jucători fotbal?", a: ["10", "11", "12", "9"], c: 1 }
        ],
        'history': [
            { q: "Start Al Doilea Război?", a: ["1914", "1939", "1945", "1918"], c: 1 },
            { q: "Primul președinte SUA?", a: ["Lincoln", "Washington", "Kennedy", "Roosevelt"], c: 1 },
            { q: "Domnitor 1448?", a: ["Vlad Țepeș", "Ștefan", "Mircea", "Mihai"], c: 0 },
            { q: "Marea Unire?", a: ["1859", "1918", "1989", "1877"], c: 1 },
            { q: "Descoperitor America?", a: ["Columb", "Magellan", "Gama", "Cortez"], c: 0 },
            { q: "Cădere Zid Berlin?", a: ["1987", "1989", "1991", "1990"], c: 1 },
            { q: "Împărat Franța?", a: ["Ludovic", "Napoleon", "Carol", "Filip"], c: 1 },
            { q: "Inventator bec?", a: ["Tesla", "Edison", "Bell", "Einstein"], c: 1 },
            { q: "Moarte Napoleon?", a: ["Franța", "Sf. Elena", "Waterloo", "Corsica"], c: 1 },
            { q: "Colosseum?", a: ["Greci", "Romani", "Otomani", "Britanici"], c: 1 },
            { q: "Doamna de Fier?", a: ["Merkel", "Thatcher", "Elisabeta", "Madonna"], c: 1 },
            { q: "Aselenizare?", a: ["1969", "1959", "1975", "1960"], c: 0 },
            { q: "Romeo și Julieta?", a: ["Shakespeare", "Hugo", "Dante", "Homer"], c: 0 },
            { q: "Război 100 ani?", a: ["Roze", "100 ani", "Cruciade", "Rece"], c: 1 },
            { q: "Mongoli?", a: ["Attila", "Genghis Khan", "Kublai", "Tamerlan"], c: 1 }
        ],
        'science': [
            { q: "Lângă Soare?", a: ["Venus", "Mercur", "Marte", "Pământ"], c: 1 },
            { q: "Barometru măsoară?", a: ["Temp", "Presiune", "Umiditate", "Viteză"], c: 1 },
            { q: "Simbol Aur?", a: ["Ag", "Au", "Fe", "Cu"], c: 1 },
            { q: "Oase adult?", a: ["206", "300", "195", "250"], c: 0 },
            { q: "Gaz respirat?", a: ["Azot", "Oxigen", "Hidrogen", "Heliu"], c: 1 },
            { q: "Relativitate?", a: ["Newton", "Einstein", "Bohr", "Hawking"], c: 1 },
            { q: "Duritate maximă?", a: ["Aur", "Diamant", "Cuarț", "Fier"], c: 1 },
            { q: "Botanica studiază?", a: ["Animale", "Plante", "Roci", "Stele"], c: 1 },
            { q: "Viteză lumină?", a: ["300k km/s", "150k km/s", "1k km/s", "Instant"], c: 0 },
            { q: "Pompă sânge?", a: ["Ficat", "Inimă", "Plămâni", "Creier"], c: 1 },
            { q: "H2O?", a: ["Acid", "Apă", "Sare", "Aer"], c: 1 },
            { q: "Straturi atmosferă?", a: ["3", "5", "7", "1"], c: 1 },
            { q: "Planeta cu inele?", a: ["Jupiter", "Saturn", "Marte", "Mercur"], c: 1 },
            { q: "Element ușor?", a: ["Heliu", "Hidrogen", "Oxigen", "Litiu"], c: 1 },
            { q: "Fotosinteza face?", a: ["Lumină", "Hrană", "Apă", "Nimic"], c: 1 }
        ]
    };

    // --- GLOBAL VARS ---
    let myUser = null;
    let currentGameId = null;
    let gameUnsub = null;
    let playersUnsub = null;
    let isHost = false;
    let currentQuestions = [];
    let myScore = 0;
    
    // UI HELPER
    const showView = (id) => {
        document.querySelectorAll('.view-section').forEach(el => { el.style.display='none'; el.classList.remove('active'); });
        const target = document.getElementById(id);
        target.style.display='flex';
        setTimeout(() => target.classList.add('active'), 10);
    };

    // --- AUTH & USER ---
    window.handleLoginFlow = () => signInWithPopup(auth, provider);
    
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            const snap = await getDoc(doc(db, "accounts", user.uid));
            if(snap.exists()) {
                myUser = snap.data();
                myUser.uid = user.uid;
                updateHeaderUI(myUser);
                showView('menuView');
                
                // Update Menu Buttons
                document.getElementById('headerLoginText').innerText = "CONT";
                document.getElementById('headerUserImg').src = user.photoURL;
                document.getElementById('headerUserImg').style.display = 'block';
                document.getElementById('headerLoginBtn').onclick = () => document.getElementById('accountModal').classList.add('active');
                
                if(document.getElementById('mobileLoginBtn')) {
                    document.getElementById('mobileLoginBtn').innerText = "CONT";
                    document.getElementById('mobileLoginBtn').onclick = () => {
                        document.getElementById('sideMenu').classList.remove('open');
                        document.getElementById('accountModal').classList.add('active');
                    };
                }
            } else {
                 // Fallback if no wall account
                showView('menuView');
            }
        } else {
            myUser = null;
            showView('lockedView');
            document.getElementById('headerLoginText').innerText = "LOGIN";
            document.getElementById('headerUserImg').style.display = 'none';
        }
    });

    function updateHeaderUI(u) {
        // Game Header
        document.getElementById('gameUserName').innerText = u.username;
        document.getElementById('gameUserCoins').innerText = u.coins || 0;
        document.getElementById('gameUserAvatar').src = u.image;
        document.getElementById('gameHeaderBar').style.display = 'flex';
        
        // Account Modal
        document.getElementById('popUserImg').src = u.image;
        document.getElementById('popUserName').innerText = u.username;
        document.getElementById('popUserEmail').innerText = u.email;

        // Apply Frame
        if(u.equippedFrame?.img) {
            const scale = (u.equippedFrame.scale || 1.45) * 100;
            const style = `display:block; width:${scale}%; height:${scale}%;`;
            document.getElementById('gameUserFrame').src = u.equippedFrame.img;
            document.getElementById('gameUserFrame').style.cssText = style;
            document.getElementById('popUserFrame').src = u.equippedFrame.img;
            document.getElementById('popUserFrame').style.cssText = style;
        }

        // Apply Banner
        if(u.equippedBanner?.cssClass) {
            document.getElementById('gameHeaderBar').className = `game-header banner-active ${u.equippedBanner.cssClass}`;
        }
    }

    // --- MULTIPLAYER CORE ---
    
    window.findMultiplayerGame = async () => {
        const q = query(collection(db, "games"), where("status", "==", "waiting"));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
            // Check player count
            const gameDoc = snapshot.docs[0];
            const pColl = collection(db, "games", gameDoc.id, "players");
            const pSnap = await getDocs(pColl);
            
            if (pSnap.size < 10) {
                currentGameId = gameDoc.id;
                await joinGame(currentGameId);
            } else {
                createNewGame();
            }
        } else {
            createNewGame();
        }
    };

    async function createNewGame() {
        const gameRef = await addDoc(collection(db, "games"), {
            status: 'waiting',
            host: myUser.uid,
            category: null,
            qIndex: 0,
            endTime: null,
            createdAt: serverTimestamp(),
            votes: { ksda:0, general:0, history:0, science:0 }
        });
        currentGameId = gameRef.id;
        isHost = true;
        await joinGame(currentGameId);
    }

    async function joinGame(gId) {
        const pRef = doc(db, "games", gId, "players", myUser.uid);
        await setDoc(pRef, {
            uid: myUser.uid,
            name: myUser.username,
            photo: myUser.image,
            frame: myUser.equippedFrame || null,
            banner: myUser.equippedBanner || null,
            score: 0,
            answer: -1,
            time: 0
        });
        
        listenToLobby(gId);
        showView('lobbyView');
    }

    function listenToLobby(gId) {
        // GAME STATE LISTENER
        gameUnsub = onSnapshot(doc(db, "games", gId), (snap) => {
            const data = snap.data();
            if(!data) return;

            // Voting Start
            if(data.status === 'voting' && document.getElementById('votingView').style.display === 'none') {
                startVotingView(data);
            }
            // Playing Start
            if(data.status === 'playing') {
                if(document.getElementById('gameView').style.display === 'none') {
                    // Start of game
                    currentQuestions = [...QUESTIONS[data.category]];
                    startGameUI(data);
                }
                handleGameUpdate(data);
            }
            // Round Results
            if(data.status === 'round_results') {
                showRoundResultsOverlay(data.qIndex);
            }
            // Finished
            if(data.status === 'finished') {
                showFinalResults();
            }
            // Votes Update
            if(data.status === 'voting') {
                updateVoteCounts(data.votes);
            }
        });

        // PLAYERS LISTENER
        playersUnsub = onSnapshot(collection(db, "games", gId, "players"), (snap) => {
            const players = [];
            snap.forEach(d => players.push(d.data()));
            renderLobby(players);
            
            // If round results is open, update the list live
            if(document.getElementById('roundResultsOverlay').style.display === 'flex') {
                renderRoundList(players);
            }
        });
    }

    function renderLobby(players) {
        const grid = document.getElementById('lobbyGrid');
        grid.innerHTML = '';
        document.getElementById('lobbyCount').innerText = `${players.length}/10`;
        
        if(isHost) {
            document.getElementById('hostControls').style.display = 'block';
            document.getElementById('waitingText').style.display = 'none';
        } else {
            document.getElementById('hostControls').style.display = 'none';
            document.getElementById('waitingText').style.display = 'block';
        }

        players.forEach(p => {
            const slot = document.createElement('div');
            let bannerClass = p.banner ? p.banner.cssClass : '';
            slot.className = `lobby-slot filled ${bannerClass}`;
            
            let frameHtml = '';
            if(p.frame) {
                const scale = (p.frame.scale || 1.45) * 100;
                frameHtml = `<img src="${p.frame.img}" class="lobby-frame" style="width:${scale}%; height:${scale}%;">`;
            }

            slot.innerHTML = `
                <div class="lobby-avatar-wrapper">
                    <img src="${p.photo}" class="lobby-avatar">
                    ${frameHtml}
                </div>
                <div class="lobby-name">${p.name}</div>
            `;
            grid.appendChild(slot);
        });
    }

    // --- VOTING ---
    window.startVotingPhase = async () => {
        if(!isHost) return;
        const endTime = Date.now() + 10000;
        await updateDoc(doc(db, "games", currentGameId), { status: 'voting', endTime: endTime });
    };

    let voteInterval;
    function startVotingView(data) {
        showView('votingView');
        voteInterval = setInterval(() => {
            const left = Math.ceil((data.endTime - Date.now()) / 1000);
            document.getElementById('voteTimer').innerText = left > 0 ? left : 0;
            if(left <= 0) {
                clearInterval(voteInterval);
                if(isHost) endVoting(data.votes);
            }
        }, 500);
    }

    window.castVote = async (cat) => {
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
        document.getElementById(`cat_${cat}`).classList.add('selected');
        const update = {}; update[`votes.${cat}`] = increment(1);
        await updateDoc(doc(db, "games", currentGameId), update);
    };

    function updateVoteCounts(votes) {
        if(!votes) return;
        for (const [k, v] of Object.entries(votes)) {
            document.getElementById(`vc_${k}`).innerText = v;
        }
    }

    async function endVoting(votes) {
        let winner = 'ksda'; let max = -1;
        for (const [k, v] of Object.entries(votes)) { if(v > max) { max = v; winner = k; } }
        
        // Show winner visual
        document.getElementById('votingResultText').innerText = `CATEGORIA ${winner.toUpperCase()} A CÂȘTIGAT!`;
        document.getElementById('votingResultText').style.display = 'block';
        document.getElementById(`cat_${winner}`).classList.add('winner');

        setTimeout(async () => {
            const endTime = Date.now() + 15000; 
            await updateDoc(doc(db, "games", currentGameId), {
                status: 'playing',
                category: winner,
                qIndex: 0,
                endTime: endTime
            });
        }, 2000);
    }

    // --- GAME LOOP ---
    let gameInterval;
    
    function startGameUI(data) {
        showView('gameView');
        document.getElementById('currentCatDisp').innerText = data.category.toUpperCase();
    }

    function handleGameUpdate(data) {
        // Hide overlay if it was open
        document.getElementById('roundResultsOverlay').style.display = 'none';

        const qIdx = data.qIndex;
        if(qIdx >= 15) return; 

        document.getElementById('qIndexDisp').innerText = qIdx + 1;
        const qData = currentQuestions[qIdx];
        document.getElementById('questionText').innerText = qData.q;
        
        const grid = document.getElementById('answersGrid');
        // Reset only if new question
        if(grid.dataset.idx != qIdx) {
            grid.dataset.idx = qIdx;
            grid.innerHTML = '';
            
            // Reset local player answer logic
            const pRef = doc(db, "games", currentGameId, "players", myUser.uid);
            updateDoc(pRef, { answer: -1 });

            qData.a.forEach((ans, i) => {
                const btn = document.createElement('div');
                btn.className = 'answer-option';
                btn.innerHTML = `<b>${String.fromCharCode(65+i)}.</b> ${ans}`;
                btn.onclick = () => submitAnswer(i, qIdx);
                grid.appendChild(btn);
            });
            
            // Timer
            if(gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(() => {
                const now = Date.now();
                const total = 15000; 
                const left = data.endTime - now;
                const pct = (left / total) * 100;
                document.getElementById('timerBar').style.width = pct + '%';
                
                if(left <= 0) {
                    clearInterval(gameInterval);
                    if(isHost) handleRoundEnd();
                }
            }, 100);
        }
    }

    window.submitAnswer = async (choice, qIdx) => {
        const options = document.querySelectorAll('.answer-option');
        options.forEach(o => o.style.pointerEvents = 'none'); 
        options[choice].classList.add('selected');
        
        const qData = currentQuestions[qIdx];
        const isCorrect = (choice === qData.c);
        const timeTaken = (15000 - (document.getElementById('timerBar').offsetWidth / document.getElementById('timerBar').parentElement.offsetWidth * 15000)) / 1000;
        
        if(isCorrect) options[choice].classList.add('correct');
        else options[choice].classList.add('wrong');
        
        const pRef = doc(db, "games", currentGameId, "players", myUser.uid);
        const update = { answer: choice, time: timeTaken.toFixed(2) };
        if(isCorrect) update.score = increment(1);
        await updateDoc(pRef, update);
    };

    async function handleRoundEnd() {
        // Host triggers round result state
        await updateDoc(doc(db, "games", currentGameId), { status: 'round_results' });
        
        setTimeout(async () => {
            const snap = await getDoc(doc(db, "games", currentGameId));
            const idx = snap.data().qIndex;
            const nextIdx = idx + 1;
            
            if(nextIdx >= 15) {
                await updateDoc(doc(db, "games", currentGameId), { status: 'finished' });
            } else {
                await updateDoc(doc(db, "games", currentGameId), {
                    status: 'playing',
                    qIndex: nextIdx,
                    endTime: Date.now() + 15000
                });
            }
        }, 5000); // 5 seconds to view results
    }

    async function showRoundResultsOverlay(qIdx) {
        const overlay = document.getElementById('roundResultsOverlay');
        const qText = document.getElementById('roundQText');
        const qData = currentQuestions[qIdx];
        qText.innerText = qData.q;
        
        // Fetch players once (listener will update list)
        const snap = await getDocs(collection(db, "games", currentGameId, "players"));
        const players = [];
        snap.forEach(d => players.push(d.data()));
        renderRoundList(players, qData.c); // Pass correct answer index
        
        overlay.style.display = 'flex';
    }

    function renderRoundList(players, correctIndex = -1) {
        // If we don't have correctIndex passed from showRoundResultsOverlay, grab current
        if(correctIndex === -1) {
             const idx = document.getElementById('answersGrid').dataset.idx;
             if(currentQuestions[idx]) correctIndex = currentQuestions[idx].c;
        }

        const list = document.getElementById('roundResultsList');
        list.innerHTML = '';
        
        // Sort: Correct first, then by time
        players.sort((a,b) => {
            const aCorrect = a.answer === correctIndex;
            const bCorrect = b.answer === correctIndex;
            if(aCorrect && !bCorrect) return -1;
            if(!aCorrect && bCorrect) return 1;
            if(aCorrect && bCorrect) return a.time - b.time;
            return 0;
        });

        players.forEach(p => {
            const isRight = p.answer === correctIndex;
            const div = document.createElement('div');
            div.className = 'round-player-row';
            
            div.innerHTML = `
                <div class="round-player-name">
                    <img src="${p.photo}" style="width:25px; height:25px; border-radius:50%;">
                    ${p.name}
                </div>
                <div class="round-player-status ${isRight ? 'status-correct' : 'status-wrong'}">
                    ${isRight ? 'CORECT' : 'GREȘIT'}
                    ${isRight ? `<span class="status-time">${p.time}s</span>` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    async function showFinalResults() {
        showView('endView');
        const snap = await getDocs(collection(db, "games", currentGameId, "players"));
        const players = [];
        snap.forEach(d => players.push(d.data()));
        
        const sorted = players.sort((a,b) => b.score - a.score);
        const cont = document.getElementById('finalLeaderboard');
        cont.innerHTML = '';
        
        sorted.forEach((p, i) => {
            const div = document.createElement('div');
            div.className = 'lb-item';
            div.innerHTML = `
                <div style="display:flex; align-items:center; gap:10px;">
                    <span class="lb-rank">#${i+1}</span>
                    <img src="${p.photo}" style="width:40px; height:40px; border-radius:50%;">
                    <span>${p.name}</span>
                </div>
                <span class="lb-score">${p.score * 25} Coins</span>
            `;
            cont.appendChild(div);
            
            // Auto Reward Self
            if(p.uid === myUser.uid) {
                const reward = p.score * 25;
                if(reward > 0) updateDoc(doc(db, "accounts", myUser.uid), { coins: increment(reward) });
            }
        });
        
        if(isHost) {
            // Cleanup logic would go here
        }
    }

    window.leaveGame = () => {
        if(gameUnsub) gameUnsub();
        if(playersUnsub) playersUnsub();
        location.reload();
    }
    
    // --- SINGLE PLAYER STUB ---
    window.startSinglePlayerSetup = () => {
        alert("Modul Single Player este în mentenanță. Te rugăm să încerci Multiplayer!");
    };

    // --- COSMETICS & MENU LOGIC ---
    document.getElementById('menuBtn').onclick = () => document.getElementById('sideMenu').classList.add('open');
    document.getElementById('closeMenu').onclick = () => document.getElementById('sideMenu').classList.remove('open');
    document.getElementById('closeAccountPop').onclick = () => document.getElementById('accountModal').classList.remove('active');
    document.getElementById('popLogoutBtn').onclick = () => { signOut(auth); document.getElementById('accountModal').classList.remove('active'); };
    
    document.getElementById('openCosmeticsBtn').onclick = () => {
        document.getElementById('accountModal').classList.remove('active');
        document.getElementById('cosmeticsSelectModal').classList.add('active');
    };

    window.openInventory = async (type) => {
        const list = document.getElementById('inventoryList');
        list.innerHTML = '<div style="color:#aaa;">Se încarcă...</div>';
        document.getElementById('cosmeticsSelectModal').classList.remove('active');
        document.getElementById('inventoryModal').classList.add('active');
        
        const userSnap = await getDoc(doc(db, "accounts", myUser.uid));
        const data = userSnap.data();
        list.innerHTML = '';

        if(type === 'frames') {
            const owned = data.ownedFrames || [];
            const equipped = data.equippedFrame?.id;
            
            if(owned.length === 0) list.innerHTML = '<p style="color:#aaa;">Nu ai rame.</p>';
            
            owned.forEach(id => {
                const item = FRAMES_DB.find(f => f.id === id);
                if(item) {
                    const isEq = (id === equipped);
                    const div = document.createElement('div');
                    div.className = 'shop-badge-item';
                    div.innerHTML = `<img src="${item.img}" style="width:50px;"> <p>${item.name}</p>`;
                    const btn = document.createElement('button');
                    btn.className = 'equip-btn';
                    btn.innerText = isEq ? "ECHIPAT" : "ECHIPEAZĂ";
                    if(!isEq) btn.onclick = () => equipItem('frame', item);
                    div.appendChild(btn);
                    list.appendChild(div);
                }
            });
        }
        else if(type === 'banners') {
            const owned = data.ownedBanners || [];
            const equipped = data.equippedBanner?.id;
            
            if(owned.length === 0) list.innerHTML = '<p style="color:#aaa;">Nu ai bannere.</p>';
            
            owned.forEach(id => {
                const item = BANNERS_DB.find(b => b.id === id);
                if(item) {
                    const isEq = (id === equipped);
                    const div = document.createElement('div');
                    div.className = 'shop-badge-item';
                    div.innerHTML = `<div class="${item.cssClass}" style="padding:10px;">PREVIEW</div> <p>${item.name}</p>`;
                    const btn = document.createElement('button');
                    btn.className = 'equip-btn';
                    btn.innerText = isEq ? "ECHIPAT" : "ECHIPEAZĂ";
                    if(!isEq) btn.onclick = () => equipItem('banner', item);
                    div.appendChild(btn);
                    list.appendChild(div);
                }
            });
        }
    };

    async function equipItem(type, item) {
        if(type === 'frame') {
            await updateDoc(doc(db, "accounts", myUser.uid), { equippedFrame: { id: item.id, img: item.img, scale: item.scale || 1.45 } });
        } else {
            await updateDoc(doc(db, "accounts", myUser.uid), { equippedBanner: { id: item.id, cssClass: item.cssClass } });
        }
        document.getElementById('inventoryModal').classList.remove('active');
        alert("Echipat!");
    }

  </script>
</body>
</html>
