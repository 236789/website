rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // =========================================================
    // 1. BANNED IPS COLLECTION
    // ID-ul documentului trebuie să fie IP-ul (ex: "192.168.1.1")
    // Nimeni nu poate scrie aici din site (doar tu manual din consolă)
    // =========================================================
    match /banned_ips/{ip} {
      allow read: if request.auth != null;
      allow write: if false; 
    }

    // =========================================================
    // 2. WALL MESSAGES
    // =========================================================
    match /wall_messages/{messageId} {
      // Oricine logat poate citi
      allow read: if request.auth != null;
      
      // CREARE MESAJ
      allow create: if request.auth != null
                    // Verificăm lungimea textului (max 500)
                    && request.resource.data.text.size() <= 500
                    && request.resource.data.text.size() > 0
                    // Verificăm identitatea
                    && request.resource.data.uid == request.auth.uid
                    // VERIFICARE BAN: IP-ul trimis nu trebuie să existe în banned_ips
                    && !exists(/databases/$(database)/documents/banned_ips/$(request.resource.data.ip));

      // ACTUALIZARE (Ex: Reacții, Ștergere logică)
      allow update: if request.auth != null 
                    // Doar autorul poate modifica (pentru ștergere/editare)
                    // Sau oricine pentru reacții (asta e mai complex de securizat perfect în reguli simple, 
                    // dar pentru acest proiect e ok să lăsăm update dacă e logat, 
                    // ideal ar fi să separăm reacțiile într-o subcolecție).
                    // Pentru simplitate aici: permitem update dacă ești logat, 
                    // dar în producție serioasă ar trebui verificat field-level.
                    && request.auth != null; 
    }
  }
}
