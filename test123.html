window.runReferralNetworkAnalytics = function() {
    const tableBody = document.getElementById('referralNetworkTableBody');
    if (!tableBody) return;

    // 1. Filtrăm utilizatorii care au invitații
    const inviters = cachedUsers.filter(u => u.referralHistory && u.referralHistory.length > 0);

    // 2. Sortăm descrescător
    inviters.sort((a, b) => b.referralHistory.length - a.referralHistory.length);

    if (inviters.length === 0) {
        tableBody.innerHTML = "<tr><td colspan='3' style='padding:40px; text-align:center; color:#888;'>Nicio invitație detectată.</td></tr>";
        return;
    }

    // 3. Randare Tabel
    tableBody.innerHTML = inviters.map(inviter => {
        const invitedUsersHtml = inviter.referralHistory.map(ref => {
            // CĂUTĂM POZA ÎN CACHE folosind UID-ul
            const invitedData = cachedUsers.find(u => u.uid === ref.uid);
            const invitedPfp = invitedData ? invitedData.pfp : 'https://i.ibb.co/XyqWk9N/def-user.png';
            
            const date = ref.timestamp ? new Date(ref.timestamp) : new Date();
            const dateStr = `${date.getDate()}/${date.getMonth()+1} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
            
            return `
                <div class="alt-user-pill" style="display: flex; align-items: center; gap: 10px; width: 100%; margin-bottom: 5px; border-color: rgba(230, 0, 169, 0.2); padding: 6px 12px; background: rgba(0,0,0,0.3);">
                    <img src="${invitedPfp}" style="width: 24px; height: 24px; border-radius: 50%; border: 1px solid #E600A9; object-fit: cover;">
                    <span style="color:#fff; font-weight:700; font-size:11px; flex: 1;">${ref.name || 'User Nou'}</span>
                    <span style="color:#E600A9; font-size:9px; font-family:'Orbitron'; opacity: 0.7;">${dateStr}</span>
                </div>
            `;
        }).join('');

        return `
            <tr>
                <td class="sticky-left">
                    <div class="td-user">
                        <img src="${inviter.pfp}" class="td-pfp" style="border-color: #E600A9;">
                        <div class="td-name">${inviter.username}</div>
                    </div>
                </td>
                <td style="text-align:left; max-width: 450px; padding: 15px;">
                    <div style="max-height: 200px; overflow-y: auto; padding-right: 5px;">
                        ${invitedUsersHtml}
                    </div>
                </td>
                <td style="font-family:'Orbitron'; font-weight:900; color:#E600A9; font-size: 18px;">
                    ${inviter.referralHistory.length}
                </td>
            </tr>
        `;
    }).join('');
};
